import React, { useState, useMemo } from 'react';
import { useData } from '../hooks/useData';
import {
  StatCard,
  LoadingSpinner,
  ErrorMessage,
  ChartContainer,
  Section,
  DashboardGrid,
} from '../components/Dashboard';
import { DemographicPieChart, ComparisonBarChart } from '../components/Charts';
import { 
  AlertTriangle, 
  AlertCircle,
  Home, 
  CheckCircle,
  Heart,
  Briefcase,
  Users,
  Shield,
} from 'lucide-react';

interface ProtectionRiskStats {
  totalAtRisk: number;
  highRisk: number;
  mediumRisk: number;
  lowRisk: number;
  avgScore: number;
  maxScore: number;
  byRiskLevel: Record<string, number>;
  byScoreBand: Record<string, number>;
}

interface ProtectionByRegion {
  childMarriage: { atRisk: number; highRisk: number; mediumRisk: number };
  childLabour: { atRisk: number; highRisk: number; mediumRisk: number };
  childTrafficking: { atRisk: number; highRisk: number; mediumRisk: number };
}

interface ProtectionCase {
  childId: string;
  age: string;
  ageBand: string;
  gender?: string;
  region: string;
  state: string;
  district: string;
  enrollmentStatus?: string;
  economicActivity?: string;
  migrationStatus?: string;
  score: number;
  riskLevel: string;
  riskFactors: string[];
}

interface SampleProtectionCases {
  childMarriage: ProtectionCase[];
  childLabour: ProtectionCase[];
  childTrafficking: ProtectionCase[];
}

interface VulnerabilityData {
  totalChildren: number;
  totalHouseholds: number;
  lastUpdated: string;
  childVulnerability: {
    byRiskLevel: Record<string, number>;
    averageScore: number;
    highRiskCount: number;
    mediumRiskCount: number;
  };
  householdVulnerability: {
    byRiskLevel: Record<string, number>;
    averageScore: number;
    highRiskCount: number;
    mediumRiskCount: number;
  };
  byYear: Record<string, { count: number; highRisk: number; mediumRisk: number; lowRisk: number; avgScore: number }>;
  byRegion: Record<string, { count: number; highRisk: number; mediumRisk: number; avgScore: number; boys: number; girls: number }>;
  byState: Record<string, { count: number; avgScore: number; highRisk: number }>;
  byDistrict: Record<string, { count: number; avgScore: number; highRisk: number }>;
  byProject: Record<string, { count: number; avgScore: number; highRisk: number }>;
  byAgeBand: Record<string, { count: number; highRisk: number; mediumRisk: number; avgScore: number }>;
  byGender: Record<string, { count: number; highRisk: number; mediumRisk: number; avgScore: number }>;
  enrollmentStatus: Record<string, number>;
  economicActivity: Record<string, number>;
  migrationStatus: Record<string, number>;
  bondedLabor: Record<string, number>;
  householdIndicators: {
    singleParent: Record<string, number>;
    grandparentHeaded: Record<string, number>;
    childHeaded: Record<string, number>;
    primaryEarnerIll: Record<string, number>;
    rationCard: Record<string, number>;
  };
  topRiskFactors: Record<string, number>;
  protectionVulnerability: {
    childMarriage: ProtectionRiskStats;
    childLabour: ProtectionRiskStats;
    childTrafficking: ProtectionRiskStats;
  };
  protectionByRegion: Record<string, ProtectionByRegion>;
  protectionByAgeBand: Record<string, ProtectionByRegion>;
  sampleHighRiskCases: Array<{
    childId: string;
    childCryAdminId: string;
    householdId: string;
    householdCryAdminId: string;
    age: string;
    ageBand: string;
    gender: string;
    region: string;
    state: string;
    district: string;
    project: string;
    enrollmentStatus: string;
    economicActivity: string;
    migrationStatus: string;
    bondedLabor: string;
    score: number;
    riskFactors: string[];
    year: number;
  }>;
  sampleProtectionCases?: SampleProtectionCases;
}

export const VulnerabilityDashboard: React.FC = () => {
  const { data: rawData, loading, error } = useData({
    dataPath: '/data/vulnerability_data.json',
  });
  
  const [filters, setFilters] = useState<{
    region?: string;
    district?: string;
    project?: string;
    ageBand?: string;
    gender?: string;
  }>({});

  const data = rawData as VulnerabilityData | null;

  // Filter options
  const filterOptions = useMemo(() => {
    if (!data) return { regions: [], districts: [], projects: [], ageBands: [], genders: [] };
    
    return {
      regions: Object.keys(data.byRegion || {}),
      districts: Object.keys(data.byDistrict || {}),
      projects: Object.keys(data.byProject || {}),
      ageBands: Object.keys(data.byAgeBand || {}),
      genders: Object.keys(data.byGender || {}),
    };
  }, [data]);

  // Filtered data based on selections
  const filteredStats = useMemo(() => {
    if (!data) return null;
    
    // If no filters, return overall stats
    if (!filters.region && !filters.district && !filters.project && !filters.ageBand && !filters.gender) {
      return {
        totalChildren: data.totalChildren,
        highRisk: data.childVulnerability.highRiskCount,
        mediumRisk: data.childVulnerability.mediumRiskCount,
        avgScore: data.childVulnerability.averageScore,
      };
    }
    
    // Apply filters - for now, show filtered region/district/project data
    if (filters.region && data.byRegion[filters.region]) {
      const regionData = data.byRegion[filters.region];
      return {
        totalChildren: regionData.count,
        highRisk: regionData.highRisk,
        mediumRisk: regionData.mediumRisk,
        avgScore: regionData.avgScore,
      };
    }
    
    if (filters.district && data.byDistrict[filters.district]) {
      const districtData = data.byDistrict[filters.district];
      return {
        totalChildren: districtData.count,
        highRisk: districtData.highRisk,
        mediumRisk: 0, // Not available in district data
        avgScore: districtData.avgScore,
      };
    }
    
    if (filters.project && data.byProject[filters.project]) {
      const projectData = data.byProject[filters.project];
      return {
        totalChildren: projectData.count,
        highRisk: projectData.highRisk,
        mediumRisk: 0, // Not available in project data
        avgScore: projectData.avgScore,
      };
    }
    
    if (filters.ageBand && data.byAgeBand[filters.ageBand]) {
      const ageData = data.byAgeBand[filters.ageBand];
      return {
        totalChildren: ageData.count,
        highRisk: ageData.highRisk,
        mediumRisk: ageData.mediumRisk,
        avgScore: ageData.avgScore,
      };
    }
    
    if (filters.gender && data.byGender[filters.gender]) {
      const genderData = data.byGender[filters.gender];
      return {
        totalChildren: genderData.count,
        highRisk: genderData.highRisk,
        mediumRisk: genderData.mediumRisk,
        avgScore: genderData.avgScore,
      };
    }
    
    return {
      totalChildren: data.totalChildren,
      highRisk: data.childVulnerability.highRiskCount,
      mediumRisk: data.childVulnerability.mediumRiskCount,
      avgScore: data.childVulnerability.averageScore,
    };
  }, [data, filters]);

  // Chart data preparation
  const enrollmentChartData = useMemo(() => {
    if (!data) return [];
    return Object.entries(data.enrollmentStatus)
      .filter(([key]) => key !== 'Not Applicable')
      .map(([name, value]) => ({
        name: name.length > 25 ? name.substring(0, 22) + '...' : name,
        value,
      }))
      .sort((a, b) => b.value - a.value);
  }, [data]);

  const riskFactorChartData = useMemo(() => {
    if (!data) return [];
    return Object.entries(data.topRiskFactors)
      .slice(0, 10)
      .map(([name, value]) => ({
        name: name.length > 20 ? name.substring(0, 17) + '...' : name,
        value,
      }));
  }, [data]);

  const regionChartData = useMemo(() => {
    if (!data) return [];
    return Object.entries(data.byRegion)
      .map(([name, stats]) => ({
        name,
        highRisk: stats.highRisk,
      }))
      .sort((a, b) => b.highRisk - a.highRisk);
  }, [data]);

  const ageBandChartData = useMemo(() => {
    if (!data) return [];
    return Object.entries(data.byAgeBand)
      .map(([name, stats]) => ({
        name,
        highRisk: stats.highRisk,
      }))
      .filter((item) => item.highRisk > 0) // Filter out zero values
      .sort((a, b) => b.highRisk - a.highRisk);
  }, [data]);

  // Protection Vulnerability Chart Data
  const protectionComparisonData = useMemo(() => {
    if (!data?.protectionVulnerability) return [];
    const pv = data.protectionVulnerability;
    return [
      { 
        name: 'Child Marriage', 
        atRisk: pv.childMarriage.totalAtRisk,
        highRisk: pv.childMarriage.highRisk,
        mediumRisk: pv.childMarriage.mediumRisk,
        avgScore: pv.childMarriage.avgScore
      },
      { 
        name: 'Child Labour', 
        atRisk: pv.childLabour.totalAtRisk,
        highRisk: pv.childLabour.highRisk,
        mediumRisk: pv.childLabour.mediumRisk,
        avgScore: pv.childLabour.avgScore
      },
      { 
        name: 'Child Trafficking', 
        atRisk: pv.childTrafficking.totalAtRisk,
        highRisk: pv.childTrafficking.highRisk,
        mediumRisk: pv.childTrafficking.mediumRisk,
        avgScore: pv.childTrafficking.avgScore
      },
    ];
  }, [data]);

  const protectionByRegionData = useMemo(() => {
    if (!data?.protectionByRegion) return [];
    return Object.entries(data.protectionByRegion).map(([region, stats]) => ({
      name: region,
      'Child Marriage': stats.childMarriage.atRisk,
      'Child Labour': stats.childLabour.atRisk,
      'Child Trafficking': stats.childTrafficking.atRisk,
    }));
  }, [data]);

  const protectionByAgeBandData = useMemo(() => {
    if (!data?.protectionByAgeBand) return [];
    // Sort by age band order
    const ageBandOrder = ['0-5M', '6M-1Y', '1-2Y', '3-5Y', '6-10Y', '11-14Y', '15-18Y'];
    return Object.entries(data.protectionByAgeBand)
      .map(([ageBand, stats]) => ({
        name: ageBand,
        'Child Marriage': stats.childMarriage.atRisk,
        'Child Labour': stats.childLabour.atRisk,
        'Child Trafficking': stats.childTrafficking.atRisk,
      }))
      .sort((a, b) => {
        const aIndex = ageBandOrder.indexOf(a.name);
        const bIndex = ageBandOrder.indexOf(b.name);
        return (aIndex === -1 ? 999 : aIndex) - (bIndex === -1 ? 999 : bIndex);
      });
  }, [data]);

  if (loading) return <LoadingSpinner />;
  if (error) return <ErrorMessage message={error} />;
  if (!data) return <ErrorMessage message="No vulnerability data available" />;

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-6">
      {/* Header */}
      <div className="mb-8">
        <h1 className="text-5xl font-bold text-gray-900 mb-3">Vulnerability Assessment Dashboard</h1>
        <p className="text-xl text-gray-600 mb-4">
          Identifying at-risk children through labor, migration, and household vulnerability analysis
        </p>
        
        {/* Context Banner */}
        <div className="bg-gradient-to-r from-red-50 to-orange-50 dark:from-red-900/50 dark:to-orange-900/50 p-6 rounded-lg shadow-md border-l-4 border-red-500">
          <h3 className="font-semibold text-red-900 dark:text-white mb-2">About This Analysis</h3>
          <p className="text-sm text-red-800 dark:text-gray-100 mb-3">
            This dashboard uses the <strong>CRY Protection Vulnerability Matrix</strong> to analyze <strong>{data.totalChildren.toLocaleString()} children</strong> from annual census, 
            education reports, and labor/migration surveys. Scores are calculated using weighted parameters:
          </p>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-red-800 dark:text-gray-100">
            <div>
              <strong>Child Marriage Factors:</strong>
              <ul className="text-xs mt-1 space-y-0.5">
                <li>Out of school girls (20pts)</li>
                <li>2+ girl children in HH (20pts)</li>
                <li>Orphan/single parent (15pts)</li>
                <li>High CM rate states (5pts)</li>
              </ul>
            </div>
            <div>
              <strong>Child Labour Factors:</strong>
              <ul className="text-xs mt-1 space-y-0.5">
                <li>Out of school (15pts)</li>
                <li>Economic activity (15pts)</li>
                <li>Migrant family (10pts)</li>
                <li>CL prone states (10pts)</li>
              </ul>
            </div>
            <div>
              <strong>Trafficking Factors:</strong>
              <ul className="text-xs mt-1 space-y-0.5">
                <li>OOS + economic activity (25pts)</li>
                <li>Migrant family (20pts)</li>
                <li>Trafficking hotspots (20pts)</li>
                <li>Orphan/single parent (20pts)</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      {/* Filters */}
      <Section title="Filters">
        <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
          {/* Region Filter */}
          <div>
            <label htmlFor="region-filter" className="block text-sm font-medium text-gray-700 mb-1">Region</label>
            <select
              id="region-filter"
              title="Filter by Region"
              value={filters.region || ''}
              onChange={(e) => setFilters({ ...filters, region: e.target.value || undefined })}
              className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
              <option value="">All Regions</option>
              {filterOptions.regions.map((region) => (
                <option key={region} value={region}>{region}</option>
              ))}
            </select>
          </div>

          {/* District Filter */}
          <div>
            <label htmlFor="district-filter" className="block text-sm font-medium text-gray-700 mb-1">District</label>
            <select
              id="district-filter"
              title="Filter by District"
              value={filters.district || ''}
              onChange={(e) => setFilters({ ...filters, district: e.target.value || undefined })}
              className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
              <option value="">All Districts</option>
              {filterOptions.districts.map((district) => (
                <option key={district} value={district}>{district}</option>
              ))}
            </select>
          </div>

          {/* Project Filter */}
          <div>
            <label htmlFor="project-filter" className="block text-sm font-medium text-gray-700 mb-1">Project</label>
            <select
              id="project-filter"
              title="Filter by Project"
              value={filters.project || ''}
              onChange={(e) => setFilters({ ...filters, project: e.target.value || undefined })}
              className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
              <option value="">All Projects</option>
              {filterOptions.projects.map((project) => (
                <option key={project} value={project}>{project}</option>
              ))}
            </select>
          </div>

          {/* Age Band Filter */}
          <div>
            <label htmlFor="age-filter" className="block text-sm font-medium text-gray-700 mb-1">Age Band</label>
            <select
              id="age-filter"
              title="Filter by Age Band"
              value={filters.ageBand || ''}
              onChange={(e) => setFilters({ ...filters, ageBand: e.target.value || undefined })}
              className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
              <option value="">All Ages</option>
              {filterOptions.ageBands.map((age) => (
                <option key={age} value={age}>{age}</option>
              ))}
            </select>
          </div>

          {/* Gender Filter */}
          <div>
            <label htmlFor="gender-filter" className="block text-sm font-medium text-gray-700 mb-1">Gender</label>
            <select
              id="gender-filter"
              title="Filter by Gender"
              value={filters.gender || ''}
              onChange={(e) => setFilters({ ...filters, gender: e.target.value || undefined })}
              className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            >
              <option value="">All Genders</option>
              {filterOptions.genders.map((gender) => (
                <option key={gender} value={gender}>{gender.charAt(0).toUpperCase() + gender.slice(1)}</option>
              ))}
            </select>
          </div>
        </div>

        {/* Clear Filters Button */}
        {(filters.region || filters.district || filters.project || filters.ageBand || filters.gender) && (
          <button
            onClick={() => setFilters({})}
            className="text-sm text-blue-600 hover:text-blue-800 font-medium"
          >
            Clear All Filters
          </button>
        )}
      </Section>

      {/* Key Statistics */}
      <Section title="Vulnerability Overview">
        <DashboardGrid columns={4}>
          <StatCard
            label="Total Children Analyzed"
            value={filteredStats?.totalChildren || 0}
          />
          <StatCard
            label="High Risk Children"
            value={filteredStats?.highRisk || 0}
            trend="stable"
          />
          <StatCard
            label="Medium Risk Children"
            value={filteredStats?.mediumRisk || 0}
          />
          <StatCard
            label="Average Vulnerability Score"
            value={`${(filteredStats?.avgScore || 0).toFixed(1)}/100`}
          />
        </DashboardGrid>

        {/* Visual Risk Cards */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
          {/* High Risk */}
          <div className="bg-white dark:bg-gray-800 border-2 border-red-500 p-6 rounded-xl shadow-lg">
            <div className="flex items-center justify-between mb-4">
              <AlertTriangle size={40} className="text-red-500" />
              <span className="text-xs text-red-600 px-3 py-1 rounded-full font-medium">Critical</span>
            </div>
            <div className="text-4xl font-bold text-gray-900 dark:text-white mb-2">
              {data.childVulnerability.highRiskCount.toLocaleString()}
            </div>
            <div className="text-sm text-gray-600 dark:text-gray-300 mb-3">High Risk Children (Score 50+)</div>
            <div className="text-xs text-red-700 dark:text-white bg-red-50 dark:bg-red-900/70 p-2 rounded">
              Require immediate intervention: dropouts, child labor, migration
            </div>
          </div>

          {/* Medium Risk */}
          <div className="bg-white dark:bg-gray-800 border-2 border-yellow-500 p-6 rounded-xl shadow-lg">
            <div className="flex items-center justify-between mb-4">
              <AlertCircle size={40} className="text-yellow-500" />
              <span className="text-xs bg-yellow-100 dark:bg-yellow-700 text-yellow-800 dark:text-white px-3 py-1 rounded-full font-medium">Warning</span>
            </div>
            <div className="text-4xl font-bold text-gray-900 dark:text-white mb-2">
              {data.childVulnerability.mediumRiskCount.toLocaleString()}
            </div>
            <div className="text-sm text-gray-600 dark:text-gray-300 mb-3">Medium Risk Children (Score 25-49)</div>
            <div className="text-xs text-yellow-700 dark:text-white bg-yellow-50 dark:bg-yellow-800/70 p-2 rounded">
              Monitor closely: economic activity, single parent, BPL status
            </div>
          </div>

          {/* Households at Risk */}
          <div className="bg-white dark:bg-gray-800 border-2 border-purple-500 p-6 rounded-xl shadow-lg">
            <div className="flex items-center justify-between mb-4">
              <Home size={40} className="text-purple-500" />
              <span className="text-xs bg-purple-100 dark:bg-purple-700 text-purple-800 dark:text-white px-3 py-1 rounded-full font-medium">Households</span>
            </div>
            <div className="text-4xl font-bold text-gray-900 dark:text-white mb-2">
              {data.householdVulnerability.highRiskCount.toLocaleString()}
            </div>
            <div className="text-sm text-gray-600 dark:text-gray-300 mb-3">High Risk Households</div>
            <div className="text-xs text-purple-700 dark:text-white bg-purple-50 dark:bg-purple-800/70 p-2 rounded">
              Child-headed, primary earner ill, missing children
            </div>
          </div>
        </div>
      </Section>

      {/* Enrollment Status Analysis */}
      <Section title="School Enrollment Status">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <ChartContainer>
            <h3 className="text-lg font-semibold mb-4 text-center">Enrollment Distribution</h3>
            <DemographicPieChart 
              data={enrollmentChartData}
            />
          </ChartContainer>

          <div className="bg-white p-6 rounded-lg shadow-md">
            <h3 className="text-lg font-semibold mb-4">Enrollment Breakdown</h3>
            <div className="space-y-3">
              {(() => {
                // Filter out "Not Applicable" to match the pie chart
                const filteredEntries = Object.entries(data.enrollmentStatus)
                  .filter(([key]) => key !== 'Not Applicable');
                const filteredTotal = filteredEntries.reduce((sum, [, count]) => sum + count, 0);
                
                return filteredEntries
                  .sort(([, a], [, b]) => b - a)
                  .map(([status, count]) => {
                    const percent = ((count / filteredTotal) * 100).toFixed(1);
                    const isRisk = status.includes('Drop out') || status.includes('Never enrolled');
                    return (
                      <div key={status} className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          {isRisk ? (
                            <AlertTriangle size={16} className="text-red-500" />
                          ) : (
                            <CheckCircle size={16} className="text-green-500" />
                          )}
                          <span className={`text-sm ${isRisk ? 'text-red-700 dark:text-red-400' : 'text-gray-700 dark:text-gray-200'}`}>
                            {status}
                          </span>
                        </div>
                        <div className="text-right">
                          <span className="font-bold">{count.toLocaleString()}</span>
                          <span className="text-gray-500 text-xs ml-2">({percent}%)</span>
                        </div>
                      </div>
                    );
                  });
              })()}
            </div>
            <div className="mt-4 pt-3 border-t text-xs text-gray-500">
              * "Not Applicable" entries excluded from enrollment analysis
            </div>
          </div>
        </div>
      </Section>

      {/* Risk Factors Analysis */}
      <Section title="Top Risk Factors">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <ChartContainer>
            <h3 className="text-lg font-semibold mb-4 text-center">Risk Factor Frequency (Log Scale)</h3>
            <ComparisonBarChart
              data={riskFactorChartData}
              xKey="name"
              yKey="value"
              scale="log"
              domain={[1, 'auto']}
            />
            <p className="text-xs text-gray-500 dark:text-gray-400 text-center mt-2">
              Logarithmic scale used to better visualize differences between small and large values
            </p>
          </ChartContainer>

          <div className="bg-white p-6 rounded-lg shadow-md">
            <h3 className="text-lg font-semibold mb-4">Risk Factor Details</h3>
            <div className="space-y-2">
              {Object.entries(data.topRiskFactors)
                .slice(0, 10)
                .map(([factor, count], idx) => (
                  <div key={factor} className={`flex items-center justify-between p-2 rounded ${idx < 3 ? 'bg-red-50 dark:bg-red-900/50' : 'bg-gray-50 dark:bg-gray-700'}`}>
                    <div className="flex items-center gap-2">
                      <span className={`w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold ${
                        idx < 3 ? 'bg-red-500 text-white' : 'bg-gray-300 text-gray-700'
                      }`}>
                        {idx + 1}
                      </span>
                      <span className="text-sm font-medium">{factor}</span>
                    </div>
                    <span className="font-bold text-gray-900">{count.toLocaleString()}</span>
                  </div>
                ))}
            </div>
          </div>
        </div>
      </Section>

      {/* Economic Activity & Migration */}
      <Section title="Labor & Migration Analysis">
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          {/* Economic Activity */}
          <div className="bg-white p-6 rounded-lg shadow-md">
            <h4 className="font-semibold text-gray-800 mb-4">Economic Activity</h4>
            <div className="space-y-2">
              {Object.entries(data.economicActivity)
                .sort(([, a], [, b]) => b - a)
                .map(([activity, count]) => {
                  const isRisk = activity.toLowerCase().includes('yes');
                  return (
                    <div key={activity} className="flex justify-between text-sm">
                      <span className={isRisk ? 'text-red-700 dark:text-red-400' : 'text-gray-600 dark:text-gray-200'}>
                        {activity.length > 25 ? activity.substring(0, 22) + '...' : activity}
                      </span>
                      <span className="font-medium">{count.toLocaleString()}</span>
                    </div>
                  );
                })}
            </div>
          </div>

          {/* Migration Status */}
          <div className="bg-white p-6 rounded-lg shadow-md">
            <h4 className="font-semibold text-gray-800 mb-4">Migration Status</h4>
            <div className="space-y-2">
              {Object.entries(data.migrationStatus)
                .sort(([, a], [, b]) => b - a)
                .map(([status, count]) => {
                  const isRisk = status.toLowerCase().includes('yes') || status.toLowerCase().includes('agent');
                  return (
                    <div key={status} className="flex justify-between text-sm">
                      <span className={isRisk ? 'text-red-700 dark:text-red-400' : 'text-gray-600 dark:text-gray-200'}>
                        {status.length > 30 ? status.substring(0, 27) + '...' : status}
                      </span>
                      <span className="font-medium">{count.toLocaleString()}</span>
                    </div>
                  );
                })}
            </div>
          </div>

          {/* Bonded Labor */}
          <div className="bg-white p-6 rounded-lg shadow-md">
            <h4 className="font-semibold text-gray-800 mb-4">Bonded Labor</h4>
            <div className="space-y-2">
              {Object.entries(data.bondedLabor).map(([status, count]) => {
                const isRisk = status.toLowerCase() === 'yes';
                return (
                  <div key={status} className={`flex justify-between text-sm p-2 rounded ${isRisk ? 'text-red-600' : ''}`}>
                    <span className={isRisk ? 'text-red-700 dark:text-white font-medium' : 'text-gray-600 dark:text-gray-200'}>{status}</span>
                    <span className="font-medium">{count.toLocaleString()}</span>
                  </div>
                );
              })}
            </div>
            {data.bondedLabor['Yes'] > 0 && (
              <div className="mt-4 p-3 bg-red-50 dark:bg-red-900/60 border border-red-200 dark:border-red-700 rounded-lg">
                <p className="text-xs text-red-800 dark:text-white">
                  <strong>Critical:</strong> {data.bondedLabor['Yes'].toLocaleString()} children identified in bonded labor situations
                </p>
              </div>
            )}
          </div>

          {/* Household Indicators */}
          <div className="bg-white p-6 rounded-lg shadow-md">
            <h4 className="font-semibold text-gray-800 mb-4">Household Risk Factors</h4>
            <div className="space-y-2 text-sm">
              <div className="flex justify-between">
                <span className="text-gray-600">Single Parent HH</span>
                <span className="font-medium">{(data.householdIndicators.singleParent['Yes'] || 0).toLocaleString()}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">Grandparent Headed</span>
                <span className="font-medium">{(data.householdIndicators.grandparentHeaded['Yes'] || 0).toLocaleString()}</span>
              </div>
              <div className="flex justify-between text-red-700 dark:text-red-400">
                <span>Child Headed HH</span>
                <span className="font-medium">{(data.householdIndicators.childHeaded['Yes'] || 0).toLocaleString()}</span>
              </div>
              <div className="flex justify-between text-red-700 dark:text-red-400">
                <span>Primary Earner Ill</span>
                <span className="font-medium">{(data.householdIndicators.primaryEarnerIll['Yes'] || 0).toLocaleString()}</span>
              </div>
              <div className="flex justify-between mt-3 pt-3 border-t">
                <span className="text-gray-600">BPL Households</span>
                <span className="font-medium">{(data.householdIndicators.rationCard['Below Poverty Line'] || 0).toLocaleString()}</span>
              </div>
            </div>
          </div>
        </div>
      </Section>

      {/* Regional Analysis */}
      <Section title="Regional Vulnerability Analysis">
        <ChartContainer>
          <h3 className="text-lg font-semibold mb-4 text-center">High Risk by Region</h3>
          <ComparisonBarChart
            data={regionChartData}
            xKey="name"
            yKey="highRisk"
          />
        </ChartContainer>

        {/* Regional Table */}
        <div className="mt-6 bg-white rounded-xl shadow-lg overflow-hidden">
          <div className="p-4 bg-gray-50 border-b">
            <h3 className="text-lg font-bold text-gray-800">Regional Breakdown</h3>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-100">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Region</th>
                  <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Total Children</th>
                  <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">High Risk</th>
                  <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Medium Risk</th>
                  <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Avg Score</th>
                  <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Boys</th>
                  <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Girls</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-200">
                {Object.entries(data.byRegion)
                  .sort(([, a], [, b]) => b.highRisk - a.highRisk)
                  .map(([region, stats], idx) => (
                    <tr key={region} className={idx % 2 === 0 ? 'bg-white dark:bg-gray-800' : 'bg-gray-50 dark:bg-gray-700'}>
                      <td className="px-6 py-4 whitespace-nowrap font-medium text-gray-900 dark:text-white">{region}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-right dark:text-gray-200">{stats.count.toLocaleString()}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-right text-red-600 dark:text-red-400 font-medium">{stats.highRisk.toLocaleString()}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-right text-yellow-600 dark:text-yellow-400">{stats.mediumRisk.toLocaleString()}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-right dark:text-gray-200">{stats.avgScore.toFixed(1)}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-right text-blue-600 dark:text-blue-400">{stats.boys.toLocaleString()}</td>
                      <td className="px-6 py-4 whitespace-nowrap text-right text-pink-600 dark:text-pink-400">{stats.girls.toLocaleString()}</td>
                    </tr>
                  ))}
              </tbody>
            </table>
          </div>
        </div>
      </Section>

      {/* Age Band Analysis */}
      <Section title="Age-wise Vulnerability">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <ChartContainer>
            <h3 className="text-lg font-semibold mb-4 text-center">High Risk by Age Group</h3>
            <ComparisonBarChart
              data={ageBandChartData}
              xKey="name"
              yKey="highRisk"
            />
          </ChartContainer>

          <div className="bg-white p-6 rounded-lg shadow-md">
            <h3 className="text-lg font-semibold mb-4">Age Group Details</h3>
            <div className="space-y-3">
              {Object.entries(data.byAgeBand)
                .sort(([, a], [, b]) => b.highRisk - a.highRisk)
                .map(([age, stats]) => (
                  <div key={age} className="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div className="flex justify-between items-center mb-2">
                      <span className="font-medium text-gray-800 dark:text-white">{age}</span>
                      <span className="text-sm text-gray-500 dark:text-gray-300">{stats.count.toLocaleString()} children</span>
                    </div>
                    <div className="flex gap-4 text-sm">
                      <span className="text-red-600 dark:text-red-400">High: {stats.highRisk.toLocaleString()}</span>
                      <span className="text-yellow-600 dark:text-yellow-400">Medium: {stats.mediumRisk.toLocaleString()}</span>
                      <span className="text-gray-500 dark:text-gray-300">Avg Score: {stats.avgScore.toFixed(1)}</span>
                    </div>
                  </div>
                ))}
            </div>
          </div>
        </div>
      </Section>

      {/* Year-over-Year Comparison */}
      <Section title="Year-over-Year Comparison (2023 vs 2024)">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {Object.entries(data.byYear).map(([year, stats]) => (
            <div key={year} className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-l-4 border-blue-500">
              <h4 className="text-2xl font-bold text-gray-800 dark:text-white mb-4">{year}</h4>
              <div className="grid grid-cols-2 gap-4">
                <div className="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded">
                  <div className="text-2xl font-bold text-gray-900 dark:text-white">{stats.count.toLocaleString()}</div>
                  <div className="text-xs text-gray-600 dark:text-gray-300">Total Children</div>
                </div>
                <div className="text-center p-3 bg-red-50 dark:bg-red-900/60 rounded">
                  <div className="text-2xl font-bold text-red-600 dark:text-white">{stats.highRisk.toLocaleString()}</div>
                  <div className="text-xs text-gray-600 dark:text-gray-300">High Risk</div>
                </div>
                <div className="text-center p-3 bg-yellow-50 dark:bg-yellow-800/60 rounded">
                  <div className="text-2xl font-bold text-yellow-600 dark:text-white">{stats.mediumRisk.toLocaleString()}</div>
                  <div className="text-xs text-gray-600 dark:text-gray-300">Medium Risk</div>
                </div>
                <div className="text-center p-3 bg-purple-50 dark:bg-purple-800/60 rounded">
                  <div className="text-2xl font-bold text-purple-600 dark:text-white">{stats.avgScore.toFixed(1)}</div>
                  <div className="text-xs text-gray-600 dark:text-gray-300">Avg Score</div>
                </div>
              </div>
            </div>
          ))}
        </div>
      </Section>

      {/* Protection Vulnerability Analysis */}
      {data.protectionVulnerability && (
        <Section title="Protection Vulnerability Analysis">
          {/* Info Banner */}
          <div className="bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/50 dark:to-pink-900/50 p-6 rounded-lg shadow-md border-l-4 border-purple-500 mb-6">
            <h3 className="font-semibold text-purple-900 dark:text-white mb-2 flex items-center gap-2">
              <Shield size={20} />
              Protection Vulnerability Scoring Matrix
            </h3>
            <p className="text-sm text-purple-800 dark:text-gray-100 mb-3">
              Scores are calculated by combining multiple weighted risk factors from CRY's data sources. <strong>High Risk = 50+ points | Medium = 25-49 | Low = 10-24</strong>
            </p>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs text-purple-800 dark:text-gray-100">
              <div className="bg-pink-100 dark:bg-pink-900/30 p-3 rounded">
                <strong>Child Marriage (Girls 10-18):</strong>
                <ul className="mt-1 space-y-1">
                  <li>Out of school girl: 20 pts</li>
                  <li>2+ girls in HH (history proxy): 20 pts</li>
                  <li>Orphan/single parent: 15 pts</li>
                  <li>Economic activity: 10 pts</li>
                  <li>High CM state: 5 pts</li>
                  <li>Irregular attendance: 5 pts</li>
                </ul>
              </div>
              <div className="bg-orange-100 dark:bg-orange-900/30 p-3 rounded">
                <strong>Child Labour (6-18 years):</strong>
                <ul className="mt-1 space-y-1">
                  <li>Out of school: 15 pts</li>
                  <li>Economic activity: 15 pts</li>
                  <li>OOS + economic combo: 10 pts</li>
                  <li>Irregular attendance: 10 pts</li>
                  <li>Migrant family: 10 pts</li>
                  <li>Orphan/single parent: 10 pts</li>
                  <li>CL prone state: 10 pts</li>
                </ul>
              </div>
              <div className="bg-orange-100 dark:bg-orange-900/30 p-3 rounded">
                <strong>Trafficking (6-18 years):</strong>
                <ul className="mt-1 space-y-1">
                  <li>OOS + economic activity: 25 pts</li>
                  <li>Migrant family: 20 pts</li>
                  <li>Orphan/single parent: 20 pts</li>
                  <li>Trafficking hotspot: 20 pts</li>
                </ul>
              </div>
            </div>
          </div>

          {/* Protection Risk Summary Cards */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            {/* Child Marriage */}
            <div className="bg-white dark:bg-gray-800 border-2 border-pink-500 p-6 rounded-xl shadow-lg">
              <div className="flex items-center justify-between mb-4">
                <Heart size={40} className="text-pink-500" />
                <span className="text-xs bg-pink-100 dark:bg-pink-700 text-pink-800 dark:text-white px-3 py-1 rounded-full font-medium">
                  Child Marriage
                </span>
              </div>
              <div className="text-4xl font-bold text-gray-900 dark:text-white mb-2">
                {data.protectionVulnerability.childMarriage.totalAtRisk.toLocaleString()}
              </div>
              <div className="text-sm text-gray-600 dark:text-gray-300 mb-3">Girls at Risk (10-18 years)</div>
              <div className="grid grid-cols-3 gap-2 text-xs">
                <div className="p-2 bg-red-50 dark:bg-red-900/50 rounded">
                  <div className="font-bold text-red-600 dark:text-red-400">
                    {data.protectionVulnerability.childMarriage.highRisk.toLocaleString()}
                  </div>
                  <div className="text-gray-600 dark:text-gray-300">High (50+)</div>
                </div>
                <div className="p-2 bg-yellow-50 dark:bg-yellow-800/50 rounded">
                  <div className="font-bold text-yellow-600 dark:text-yellow-400">
                    {data.protectionVulnerability.childMarriage.mediumRisk.toLocaleString()}
                  </div>
                  <div className="text-gray-600 dark:text-gray-300">Medium (25-49)</div>
                </div>
                <div className="p-2 bg-blue-50 dark:bg-blue-800/50 rounded">
                  <div className="font-bold text-blue-600 dark:text-blue-400">
                    {data.protectionVulnerability.childMarriage.lowRisk.toLocaleString()}
                  </div>
                  <div className="text-gray-600 dark:text-gray-300">Low (1-24)</div>
                </div>
              </div>
              <div className="mt-3 text-xs text-pink-700 dark:text-white bg-pink-50 dark:bg-pink-900/70 p-2 rounded">
                Max Score: {data.protectionVulnerability.childMarriage.maxScore || 'N/A'} | Avg: {data.protectionVulnerability.childMarriage.avgScore.toFixed(1)}
              </div>
            </div>

            {/* Child Labour */}
            <div className="bg-white dark:bg-gray-800 border-2 border-orange-500 p-6 rounded-xl shadow-lg">
              <div className="flex items-center justify-between mb-4">
                <Briefcase size={40} className="text-orange-500" />
                <span className="text-xs bg-orange-100 dark:bg-orange-700 text-orange-800 dark:text-white px-3 py-1 rounded-full font-medium">
                  Child Labour
                </span>
              </div>
              <div className="text-4xl font-bold text-gray-900 dark:text-white mb-2">
                {data.protectionVulnerability.childLabour.totalAtRisk.toLocaleString()}
              </div>
              <div className="text-sm text-gray-600 dark:text-gray-300 mb-3">Children at Risk (6-18 years)</div>
              <div className="grid grid-cols-3 gap-2 text-xs">
                <div className="p-2 bg-red-50 dark:bg-red-900/50 rounded">
                  <div className="font-bold text-red-600 dark:text-red-400">
                    {data.protectionVulnerability.childLabour.highRisk.toLocaleString()}
                  </div>
                  <div className="text-gray-600 dark:text-gray-300">High (50+)</div>
                </div>
                <div className="p-2 bg-yellow-50 dark:bg-yellow-800/50 rounded">
                  <div className="font-bold text-yellow-600 dark:text-yellow-400">
                    {data.protectionVulnerability.childLabour.mediumRisk.toLocaleString()}
                  </div>
                  <div className="text-gray-600 dark:text-gray-300">Medium (25-49)</div>
                </div>
                <div className="p-2 bg-blue-50 dark:bg-blue-800/50 rounded">
                  <div className="font-bold text-blue-600 dark:text-blue-400">
                    {data.protectionVulnerability.childLabour.lowRisk.toLocaleString()}
                  </div>
                  <div className="text-gray-600 dark:text-gray-300">Low (1-24)</div>
                </div>
              </div>
              <div className="mt-3 text-xs text-orange-700 dark:text-white bg-orange-50 dark:bg-orange-900/70 p-2 rounded">
                Max Score: {data.protectionVulnerability.childLabour.maxScore || 'N/A'} | Avg: {data.protectionVulnerability.childLabour.avgScore.toFixed(1)}
              </div>
            </div>

            {/* Child Trafficking */}
            <div className="bg-white dark:bg-gray-800 border-2 border-red-600 p-6 rounded-xl shadow-lg">
              <div className="flex items-center justify-between mb-4">
                <Users size={40} className="text-red-600" />
                <span className="text-xs bg-red-100 dark:bg-red-700 text-red-800 dark:text-white px-3 py-1 rounded-full font-medium">
                  Child Trafficking
                </span>
              </div>
              <div className="text-4xl font-bold text-gray-900 dark:text-white mb-2">
                {data.protectionVulnerability.childTrafficking.totalAtRisk.toLocaleString()}
              </div>
              <div className="text-sm text-gray-600 dark:text-gray-300 mb-3">Children at Risk (6-18 years)</div>
              <div className="grid grid-cols-3 gap-2 text-xs">
                <div className="p-2 bg-red-50 dark:bg-red-900/50 rounded">
                  <div className="font-bold text-red-600 dark:text-red-400">
                    {data.protectionVulnerability.childTrafficking.highRisk.toLocaleString()}
                  </div>
                  <div className="text-gray-600 dark:text-gray-300">High (50+)</div>
                </div>
                <div className="p-2 bg-yellow-50 dark:bg-yellow-800/50 rounded">
                  <div className="font-bold text-yellow-600 dark:text-yellow-400">
                    {data.protectionVulnerability.childTrafficking.mediumRisk.toLocaleString()}
                  </div>
                  <div className="text-gray-600 dark:text-gray-300">Medium (25-49)</div>
                </div>
                <div className="p-2 bg-blue-50 dark:bg-blue-800/50 rounded">
                  <div className="font-bold text-blue-600 dark:text-blue-400">
                    {data.protectionVulnerability.childTrafficking.lowRisk.toLocaleString()}
                  </div>
                  <div className="text-gray-600 dark:text-gray-300">Low (1-24)</div>
                </div>
              </div>
              <div className="mt-3 text-xs text-red-700 dark:text-white bg-red-50 dark:bg-red-900/70 p-2 rounded">
                Max Score: {data.protectionVulnerability.childTrafficking.maxScore || 'N/A'} | Avg: {data.protectionVulnerability.childTrafficking.avgScore.toFixed(1)}
              </div>
            </div>
          </div>

          {/* Methodology Note */}
          <div className="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-700 p-4 rounded-lg mb-6">
            <h3 className="font-semibold text-green-800 dark:text-green-200 mb-2"> Enhanced Scoring Methodology</h3>
            <p className="text-sm text-green-700 dark:text-green-300">
              Vulnerability scores now incorporate data from <strong>Child Annual Census, Education Reports, and Labour/Migration Surveys</strong>. 
              Key correlations used: household composition (2+ girl children as proxy for CM history), school enrollment/attendance status, 
              migration patterns, orphan/single-parent status, and geographic risk factors based on <strong>NFHS-5 (2019-21)</strong> state-level indicators.
              <br/><strong>Score Bands:</strong> High Risk (50+) | Medium Risk (25-49) | Low Risk (10-24) | Minimal (0-9)
            </p>
          </div>

          {/* Protection Comparison Chart */}
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <ChartContainer>
              <h3 className="text-lg font-semibold mb-4 text-center">Protection Issues - Total At Risk</h3>
              <ComparisonBarChart
                data={protectionComparisonData}
                xKey="name"
                yKey="atRisk"
              />
            </ChartContainer>

            {/* Protection Risk Level Breakdown */}
            <div className="bg-white p-6 rounded-lg shadow-md">
              <h3 className="text-lg font-semibold mb-4">Risk Level Breakdown</h3>
              <div className="space-y-4">
                {protectionComparisonData.map((item) => (
                  <div key={item.name} className="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div className="flex justify-between items-center mb-2">
                      <span className="font-medium text-gray-800 dark:text-white">{item.name}</span>
                      <span className="text-sm text-gray-500 dark:text-gray-300">
                        {item.atRisk.toLocaleString()} at risk
                      </span>
                    </div>
                    <div className="flex gap-4 text-sm">
                      <span className="text-red-600 dark:text-red-400">High: {item.highRisk.toLocaleString()}</span>
                      <span className="text-yellow-600 dark:text-yellow-400">Medium: {item.mediumRisk.toLocaleString()}</span>
                      <span className="text-gray-500 dark:text-gray-300">Avg Score: {item.avgScore.toFixed(1)}</span>
                    </div>
                    {/* Progress bar */}
                    <div className="mt-2 h-2 bg-gray-200 dark:bg-gray-600 rounded-full overflow-hidden">
                      <div 
                        className="h-full bg-gradient-to-r from-red-500 via-yellow-500 to-green-500"
                        style={{ width: `${Math.min(item.avgScore, 100)}%` }}
                      />
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* Protection by Region */}
          {protectionByRegionData.length > 0 && (
            <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
              <div className="p-4 bg-purple-50 dark:bg-purple-900/50 border-b">
                <h3 className="text-lg font-bold text-gray-800 dark:text-white">Protection Risks by Region</h3>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-100 dark:bg-gray-700">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Region</th>
                      <th className="px-6 py-3 text-right text-xs font-medium text-pink-600 uppercase">Child Marriage</th>
                      <th className="px-6 py-3 text-right text-xs font-medium text-orange-600 uppercase">Child Labour</th>
                      <th className="px-6 py-3 text-right text-xs font-medium text-red-600 uppercase">Trafficking</th>
                      <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Total At Risk</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200 dark:divide-gray-600">
                    {protectionByRegionData
                      .sort((a, b) => (b['Child Marriage'] + b['Child Labour'] + b['Child Trafficking']) - (a['Child Marriage'] + a['Child Labour'] + a['Child Trafficking']))
                      .map((row, idx) => (
                        <tr key={row.name} className={idx % 2 === 0 ? 'bg-white dark:bg-gray-800' : 'bg-gray-50 dark:bg-gray-700'}>
                          <td className="px-6 py-4 whitespace-nowrap font-medium text-gray-900 dark:text-white">{row.name}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-right text-pink-600 dark:text-pink-400">{row['Child Marriage'].toLocaleString()}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-right text-orange-600 dark:text-orange-400">{row['Child Labour'].toLocaleString()}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-right text-red-600 dark:text-red-400">{row['Child Trafficking'].toLocaleString()}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-right font-bold text-gray-900 dark:text-white">
                            {(row['Child Marriage'] + row['Child Labour'] + row['Child Trafficking']).toLocaleString()}
                          </td>
                        </tr>
                      ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* Protection by Age Band */}
          {protectionByAgeBandData.length > 0 && (
            <div className="bg-white rounded-xl shadow-lg overflow-hidden">
              <div className="p-4 bg-purple-50 dark:bg-purple-900/50 border-b">
                <h3 className="text-lg font-bold text-gray-800 dark:text-white">Protection Risks by Age Band</h3>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-100 dark:bg-gray-700">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Age Band</th>
                      <th className="px-6 py-3 text-right text-xs font-medium text-pink-600 uppercase">Child Marriage</th>
                      <th className="px-6 py-3 text-right text-xs font-medium text-orange-600 uppercase">Child Labour</th>
                      <th className="px-6 py-3 text-right text-xs font-medium text-red-600 uppercase">Trafficking</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200 dark:divide-gray-600">
                    {protectionByAgeBandData.map((row, idx) => (
                      <tr key={row.name} className={idx % 2 === 0 ? 'bg-white dark:bg-gray-800' : 'bg-gray-50 dark:bg-gray-700'}>
                        <td className="px-6 py-4 whitespace-nowrap font-medium text-gray-900 dark:text-white">{row.name}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-right text-pink-600 dark:text-pink-400">
                          {row['Child Marriage'] > 0 ? row['Child Marriage'].toLocaleString() : '-'}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-right text-orange-600 dark:text-orange-400">
                          {row['Child Labour'] > 0 ? row['Child Labour'].toLocaleString() : '-'}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-right text-red-600 dark:text-red-400">
                          {row['Child Trafficking'] > 0 ? row['Child Trafficking'].toLocaleString() : '-'}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              <div className="p-4 bg-gray-50 dark:bg-gray-700 text-xs text-gray-600 dark:text-gray-300">
                <strong>Note:</strong> Child Marriage risk applies only to adolescent girls (10-18 years). 
                Child Labour and Trafficking risks apply to children 6-18 years. 
                Younger age groups show "-" where the protection parameter is not applicable.
              </div>
            </div>
          )}

          {/* Sample High-Risk Protection Cases */}
          {data.sampleProtectionCases && (
            <div className="mt-6">
              <h2 className="text-lg font-bold text-gray-800 dark:text-white mb-4">Top Cases by Protection-Specific Score</h2>
              <p className="text-sm text-gray-600 dark:text-gray-400 mb-4">These cases are scored using the weighted parameters from the Protection Vulnerability Excel (different from General Vulnerability scores below).</p>
              
              {/* Child Labour High Risk Cases - Most actionable since they have highest scores */}
              {data.sampleProtectionCases.childLabour && data.sampleProtectionCases.childLabour.length > 0 && (
                <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden mb-4">
                  <div className="p-4 bg-orange-50 dark:bg-orange-900/50 border-b">
                    <h4 className="font-bold text-orange-800 dark:text-orange-200">
                      Child Labour - Top Risk Cases (Score 50+)
                    </h4>
                  </div>
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-100 dark:bg-gray-700">
                        <tr>
                          <th className="px-4 py-2 text-left font-medium text-gray-500 dark:text-gray-300">Child ID</th>
                          <th className="px-4 py-2 text-left font-medium text-gray-500 dark:text-gray-300">Age/Gender</th>
                          <th className="px-4 py-2 text-left font-medium text-gray-500 dark:text-gray-300">Location</th>
                          <th className="px-4 py-2 text-center font-medium text-gray-500 dark:text-gray-300">Score</th>
                          <th className="px-4 py-2 text-left font-medium text-gray-500 dark:text-gray-300">Risk Factors</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-200 dark:divide-gray-600">
                        {data.sampleProtectionCases.childLabour.slice(0, 10).map((child, idx) => (
                          <tr key={idx} className={idx % 2 === 0 ? 'bg-white dark:bg-gray-800' : 'bg-gray-50 dark:bg-gray-700'}>
                            <td className="px-4 py-2 font-mono text-xs break-all max-w-[150px]">{child.childId}</td>
                            <td className="px-4 py-2">
                              <span className="font-medium">{child.ageBand}</span>
                              <span className="text-gray-500 ml-1">({child.gender})</span>
                            </td>
                            <td className="px-4 py-2">
                              <div>{child.district}</div>
                              <div className="text-xs text-gray-500">{child.state}</div>
                            </td>
                            <td className="px-4 py-2 text-center">
                              <span className={`font-bold px-2 py-1 rounded ${
                                child.score >= 50 ? 'font-bold text-red-600 dark:text-red-400' : 
                                child.score >= 25 ? 'bg-yellow-100 text-yellow-700' : 'bg-blue-100 text-blue-700'
                              }`}>
                                {child.score}
                              </span>
                            </td>
                            <td className="px-4 py-2 text-xs text-gray-600 dark:text-gray-300">
                              {child.riskFactors?.join(', ') || 'N/A'}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {/* Child Trafficking High Risk Cases */}
              {data.sampleProtectionCases.childTrafficking && data.sampleProtectionCases.childTrafficking.length > 0 && (
                <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden mb-4">
                  <div className="p-4 bg-red-50 dark:bg-red-900/50 border-b">
                    <h4 className="font-bold text-red-800 dark:text-red-200">
                      Child Trafficking - Top Risk Cases
                    </h4>
                  </div>
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-100 dark:bg-gray-700">
                        <tr>
                          <th className="px-4 py-2 text-left font-medium text-gray-500 dark:text-gray-300">Child ID</th>
                          <th className="px-4 py-2 text-left font-medium text-gray-500 dark:text-gray-300">Age/Gender</th>
                          <th className="px-4 py-2 text-left font-medium text-gray-500 dark:text-gray-300">Location</th>
                          <th className="px-4 py-2 text-center font-medium text-gray-500 dark:text-gray-300">Score</th>
                          <th className="px-4 py-2 text-left font-medium text-gray-500 dark:text-gray-300">Risk Factors</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-200 dark:divide-gray-600">
                        {data.sampleProtectionCases.childTrafficking.slice(0, 10).map((child, idx) => (
                          <tr key={idx} className={idx % 2 === 0 ? 'bg-white dark:bg-gray-800' : 'bg-gray-50 dark:bg-gray-700'}>
                            <td className="px-4 py-2 font-mono text-xs break-all max-w-[150px]">{child.childId}</td>
                            <td className="px-4 py-2">
                              <span className="font-medium">{child.ageBand}</span>
                              <span className="text-gray-500 ml-1">({child.gender})</span>
                            </td>
                            <td className="px-4 py-2">
                              <div>{child.district}</div>
                              <div className="text-xs text-gray-500">{child.state}</div>
                            </td>
                            <td className="px-4 py-2 text-center">
                              <span className={`font-bold px-2 py-1 rounded ${
                                child.score >= 50 ? 'font-bold text-red-600 dark:text-red-400' : 
                                child.score >= 25 ? 'bg-yellow-100 text-yellow-700' : 'bg-blue-100 text-blue-700'
                              }`}>
                                {child.score}
                              </span>
                            </td>
                            <td className="px-4 py-2 text-xs text-gray-600 dark:text-gray-300">
                              {child.riskFactors?.join(', ') || 'N/A'}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {/* Child Marriage Cases */}
              {data.sampleProtectionCases.childMarriage && data.sampleProtectionCases.childMarriage.length > 0 && (
                <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                  <div className="p-4 bg-pink-50 dark:bg-pink-900/50 border-b">
                    <h4 className="font-bold text-pink-800 dark:text-pink-200">
                      Child Marriage - Top Risk Cases (Adolescent Girls)
                    </h4>
                  </div>
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-100 dark:bg-gray-700">
                        <tr>
                          <th className="px-4 py-2 text-left font-medium text-gray-500 dark:text-gray-300">Child ID</th>
                          <th className="px-4 py-2 text-left font-medium text-gray-500 dark:text-gray-300">Age Band</th>
                          <th className="px-4 py-2 text-left font-medium text-gray-500 dark:text-gray-300">Location</th>
                          <th className="px-4 py-2 text-left font-medium text-gray-500 dark:text-gray-300">Enrollment</th>
                          <th className="px-4 py-2 text-center font-medium text-gray-500 dark:text-gray-300">Score</th>
                          <th className="px-4 py-2 text-left font-medium text-gray-500 dark:text-gray-300">Risk Factors</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-200 dark:divide-gray-600">
                        {data.sampleProtectionCases.childMarriage.slice(0, 10).map((child, idx) => (
                          <tr key={idx} className={idx % 2 === 0 ? 'bg-white dark:bg-gray-800' : 'bg-gray-50 dark:bg-gray-700'}>
                            <td className="px-4 py-2 font-mono text-xs break-all max-w-[150px]">{child.childId}</td>
                            <td className="px-4 py-2 font-medium">{child.ageBand}</td>
                            <td className="px-4 py-2">
                              <div>{child.district}</div>
                              <div className="text-xs text-gray-500">{child.state}</div>
                            </td>
                            <td className="px-4 py-2 text-xs">
                              <span className={`px-2 py-1 rounded ${
                                child.enrollmentStatus?.includes('Drop out') ? 'bg-red-100 text-red-600' :
                                child.enrollmentStatus?.includes('Never') ? 'bg-orange-100 text-orange-600' :
                                'bg-green-100 text-green-600'
                              }`}>
                                {(child.enrollmentStatus?.length ?? 0) > 20 ? child.enrollmentStatus?.substring(0, 17) + '...' : child.enrollmentStatus || 'N/A'}
                              </span>
                            </td>
                            <td className="px-4 py-2 text-center">
                              <span className={`font-bold px-2 py-1 rounded ${
                                child.score >= 50 ? 'font-bold text-red-600 dark:text-red-400' : 
                                child.score >= 25 ? 'bg-yellow-100 text-yellow-700' : 'bg-blue-100 text-blue-700'
                              }`}>
                                {child.score}
                              </span>
                            </td>
                            <td className="px-4 py-2 text-xs text-gray-600 dark:text-gray-300">
                              {child.riskFactors?.join(', ') || 'N/A'}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </div>
          )}
        </Section>
      )}

      {/* Sample High-Risk Cases - General Vulnerability */}
      <Section title="Sample High-Risk Cases (General Vulnerability)">
        <div className="bg-yellow-50 dark:bg-yellow-900/50 p-4 rounded-lg mb-4 border-l-4 border-yellow-500">
          <p className="text-sm text-yellow-800 dark:text-white">
            <strong>Note:</strong> This section uses the <strong>General Vulnerability Score</strong> which combines ALL risk factors into a single score. 
            Different from Protection-Specific scores above which use weighted parameters per Excel guidelines.
          </p>
          <p className="text-sm text-yellow-800 dark:text-white mt-2">
            <strong>Scoring:</strong> dropout (+30), never enrolled (+25), child labor (+20), bonded labor (+40), migration (+15), 
            single parent (+10), child-headed HH (+25), BPL (+5). Scores 50+ = High Risk, 25-49 = Medium, 10-24 = Low.
          </p>
        </div>
        
        <div className="overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow">
          <table className="w-full text-sm">
            <thead className="bg-gray-100 dark:bg-gray-700">
              <tr>
                <th className="px-4 py-3 text-left font-medium text-gray-500 dark:text-gray-300">Child ID</th>
                <th className="px-4 py-3 text-left font-medium text-gray-500 dark:text-gray-300">Household ID</th>
                <th className="px-4 py-3 text-left font-medium text-gray-500 dark:text-gray-300">Age/Gender</th>
                <th className="px-4 py-3 text-left font-medium text-gray-500 dark:text-gray-300">Location</th>
                <th className="px-4 py-3 text-left font-medium text-gray-500 dark:text-gray-300">Enrollment</th>
                <th className="px-4 py-3 text-center font-medium text-gray-500 dark:text-gray-300">Score</th>
                <th className="px-4 py-3 text-left font-medium text-gray-500 dark:text-gray-300">Risk Factors</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200 dark:divide-gray-600">
              {data.sampleHighRiskCases.slice(0, 20).map((child, idx) => (
                <tr key={idx} className={idx % 2 === 0 ? 'bg-white dark:bg-gray-800' : 'bg-gray-50 dark:bg-gray-700'}>
                  <td className="px-4 py-3">
                    <div className="font-mono text-xs text-gray-700 dark:text-gray-200 break-all max-w-[200px]" title={child.childId}>
                      {child.childId}
                    </div>
                    <div className="text-xs text-gray-400 dark:text-gray-500 mt-1">CRY: {child.childCryAdminId}</div>
                  </td>
                  <td className="px-4 py-3">
                    <div className="font-mono text-xs text-blue-600 dark:text-blue-400 break-all max-w-[200px]" title={child.householdId}>
                      {child.householdId}
                    </div>
                    <div className="text-xs text-gray-400 dark:text-gray-500 mt-1">CRY: {child.householdCryAdminId}</div>
                  </td>
                  <td className="px-4 py-3">
                    <span className="font-medium dark:text-gray-200">{child.ageBand}</span>
                    <span className="text-gray-500 dark:text-gray-400 ml-2">({child.gender.charAt(0).toUpperCase() + child.gender.slice(1)})</span>
                  </td>
                  <td className="px-4 py-3">
                    <div className="text-gray-800 dark:text-gray-200">{child.district}</div>
                    <div className="text-xs text-gray-500 dark:text-gray-400">{child.state}</div>
                  </td>
                  <td className="px-4 py-3">
                    <span className={`text-xs px-2 py-1 rounded ${
                      child.enrollmentStatus.includes('Drop out') ? 'bg-red-100 dark:bg-red-900/50 text-red-600 dark:text-red-300' :
                      child.enrollmentStatus.includes('Never') ? 'bg-orange-100 dark:bg-orange-900/50 text-orange-800 dark:text-orange-300' :
                      'bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300'
                    }`}>
                      {child.enrollmentStatus.length > 20 ? child.enrollmentStatus.substring(0, 17) + '...' : child.enrollmentStatus}
                    </span>
                  </td>
                  <td className="px-4 py-3 text-center">
                    <span className="font-bold text-red-600 dark:text-red-400">{child.score}</span>
                  </td>
                  <td className="px-4 py-3">
                    <span className="text-xs text-red-700 dark:text-red-300">
                      {child.riskFactors.slice(0, 5).join(', ')}
                    </span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </Section>

      {/* Action Recommendations */}
      <Section title="Recommended Actions">
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div className="bg-red-50 dark:bg-red-900/50 p-6 rounded-lg border-l-4 border-red-500">
            <h4 className="font-bold text-red-900 dark:text-white mb-3">Immediate Priority</h4>
            <ul className="text-sm text-red-800 dark:text-gray-100 space-y-2">
              <li>Investigate {data.bondedLabor['Yes']?.toLocaleString() || 0} bonded labor cases</li>
              <li>Re-enroll {(data.enrollmentStatus['Drop out of School'] || 0).toLocaleString()} dropouts</li>
              <li>Support {data.householdIndicators.childHeaded['Yes']?.toLocaleString() || 0} child-headed households</li>
            </ul>
          </div>

          <div className="bg-yellow-50 dark:bg-yellow-900/50 p-6 rounded-lg border-l-4 border-yellow-500">
            <h4 className="font-bold text-yellow-900 dark:text-white mb-3">Short-term Focus</h4>
            <ul className="text-sm text-yellow-800 dark:text-gray-100 space-y-2">
              <li>Monitor {data.childVulnerability.mediumRiskCount.toLocaleString()} medium-risk children</li>
              <li>Economic support for BPL households</li>
              <li>Track migrating families monthly</li>
            </ul>
          </div>

          <div className="bg-green-50 dark:bg-green-900/50 p-6 rounded-lg border-l-4 border-green-500">
            <h4 className="font-bold text-green-900 dark:text-white mb-3">Prevention Strategies</h4>
            <ul className="text-sm text-green-800 dark:text-gray-100 space-y-2">
              <li>Strengthen school retention programs</li>
              <li>Livelihood support for vulnerable HHs</li>
              <li>Community awareness on child rights</li>
            </ul>
          </div>
        </div>
      </Section>

      {/* Summary & Insights */}
      <Section title="Summary & Insights">
        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg shadow-md">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h4 className="font-bold text-blue-900 mb-3">Key Findings</h4>
              <ul className="text-sm text-blue-800 space-y-2">
                <li><strong>{((data.childVulnerability.highRiskCount / data.totalChildren) * 100).toFixed(1)}%</strong> of children are at high risk</li>
                <li><strong>Dropouts</strong> ({(data.enrollmentStatus['Drop out of School'] || 0).toLocaleString()}) are the largest vulnerability group</li>
                <li><strong>Economic activity</strong> affects {Object.entries(data.economicActivity).filter(([k]) => k.includes('Yes')).reduce((sum, [, v]) => sum + v, 0).toLocaleString()} children</li>
                <li><strong>{data.householdIndicators.singleParent['Yes']?.toLocaleString() || 0}</strong> single-parent households need support</li>
              </ul>
            </div>
            <div>
              <h4 className="font-bold text-blue-900 mb-3">Data Coverage</h4>
              <ul className="text-sm text-blue-800 space-y-2">
                <li><strong>{data.totalChildren.toLocaleString()}</strong> children from labor/migration surveys</li>
                <li><strong>{data.totalHouseholds.toLocaleString()}</strong> households analyzed</li>
                <li><strong>{Object.keys(data.byRegion).length}</strong> regions covered</li>
                <li>Data from <strong>2023 & 2024</strong> combined</li>
              </ul>
            </div>
          </div>
        </div>
      </Section>
    </div>
  );
};
