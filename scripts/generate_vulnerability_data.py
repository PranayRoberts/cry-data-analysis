"""
Generate vulnerability analysis data from Labor/Migration and Household Excel files.
Links Child ID to Household ID to create comprehensive vulnerability scoring.
"""
import pandas as pd
import json
import numpy as np
from pathlib import Path

# Paths
EXCEL_DIR = Path("D:/React/cry-data-analysis/excel-data")
OUTPUT_PATH = Path("D:/React/cry-data-analysis/public/data/vulnerability_data.json")

def load_labor_data():
    """Load and combine labor/migration data from 2023 and 2024."""
    print("Loading Labor & Migration data...")
    
    df_2024 = pd.read_excel(EXCEL_DIR / "Consolidated_Labour_and_Migration_2024.xlsx")
    df_2024['Year'] = 2024
    print(f"  2024: {len(df_2024)} records")
    
    df_2023 = pd.read_excel(EXCEL_DIR / "Consolidated-labour-and-migration2023.xlsx")
    df_2023['Year'] = 2023
    print(f"  2023: {len(df_2023)} records")
    
    # Combine
    df = pd.concat([df_2023, df_2024], ignore_index=True)
    print(f"  Combined: {len(df)} records")
    return df

def load_household_data():
    """Load and combine household data from 2023 and 2024."""
    print("Loading Household data...")
    
    xl_2024 = pd.ExcelFile(EXCEL_DIR / "HH-2024.xlsx")
    df_2024 = pd.read_excel(xl_2024, sheet_name='house-hold-information')
    df_2024['Year'] = 2024
    print(f"  2024: {len(df_2024)} records")
    
    xl_2023 = pd.ExcelFile(EXCEL_DIR / "HH-2023.xlsx")
    df_2023 = pd.read_excel(xl_2023, sheet_name='house-hold-information')
    df_2023['Year'] = 2023
    print(f"  2023: {len(df_2023)} records")
    
    # Combine
    df = pd.concat([df_2023, df_2024], ignore_index=True)
    print(f"  Combined: {len(df)} records")
    return df

def calculate_child_vulnerability_score(row):
    """Calculate vulnerability score for a child based on labor/migration indicators."""
    score = 0
    risk_factors = []
    
    # Enrollment status (high weight)
    enrollment = str(row.get('Enrollment status', '')).lower()
    if 'drop out' in enrollment:
        score += 30
        risk_factors.append('Dropout')
    elif 'never enrolled' in enrollment:
        score += 35
        risk_factors.append('Never Enrolled')
    elif 'not applicable' in enrollment:
        score += 5
    
    # Economic activity involvement
    economic = str(row.get('Is the child involved in any Economic activities? (with or without wage/ monetary compensation for the child)', '')).lower()
    if 'yes outside home alone' in economic:
        score += 25
        risk_factors.append('Child Labor (Outside Alone)')
    elif 'yes outside with family' in economic:
        score += 15
        risk_factors.append('Child Labor (With Family)')
    elif 'yes at home' in economic:
        score += 10
        risk_factors.append('Economic Activity (Home)')
    
    # Bonded labor (critical)
    bonded = str(row.get('Bonded labour involvement', '')).lower()
    if bonded == 'yes':
        score += 40
        risk_factors.append('Bonded Labor')
    
    # Migration
    migrated = str(row.get('Child migrated in the last 3 months?', '')).lower()
    if 'yes, alone' in migrated:
        score += 25
        risk_factors.append('Migrated Alone')
    elif 'agent' in migrated or 'labour' in migrated:
        score += 35
        risk_factors.append('Migrated via Agent')
    elif 'yes with family' in migrated:
        score += 10
        risk_factors.append('Migrated with Family')
    elif 'yes, with relatives' in migrated:
        score += 15
        risk_factors.append('Migrated with Relatives')
    
    # Hours of work
    hours = row.get('Number of hours of involvement', 0)
    try:
        if pd.notna(hours):
            hours = float(str(hours).replace(',', ''))
            if hours > 6:
                score += 15
                risk_factors.append(f'Long Work Hours ({int(hours)}h)')
            elif hours > 3:
                score += 8
    except:
        pass
    
    # Normalize score to 0-100
    score = min(score, 100)
    
    return score, risk_factors

def calculate_household_vulnerability(row):
    """Calculate household vulnerability indicators."""
    score = 0
    risk_factors = []
    
    # Single parent
    single_parent = str(row.get('Whether the HH is headed by a single parent', '')).lower()
    if single_parent == 'yes':
        score += 15
        risk_factors.append('Single Parent')
    
    # Grandparent headed
    grandparent = str(row.get('Whether the HH is headed by grand parents', '')).lower()
    if grandparent == 'yes':
        score += 12
        risk_factors.append('Grandparent Headed')
    
    # Child headed (critical)
    child_headed = str(row.get('Whether headed by children (18 years and below)', '')).lower()
    if child_headed == 'yes':
        score += 30
        risk_factors.append('Child Headed Household')
    
    # Primary earner ill
    earner_ill = str(row.get('Whether the primary bread-earner of the HH is terminally/seriously ill', '')).lower()
    if earner_ill == 'yes':
        score += 20
        risk_factors.append('Primary Earner Ill')
    
    # Ration card status
    ration = str(row.get('Type of Ration card', '')).lower()
    if 'below poverty' in ration:
        score += 10
        risk_factors.append('BPL')
    elif 'no ration' in ration:
        score += 15
        risk_factors.append('No Ration Card')
    
    # Migration status
    migrates = str(row.get('Whether Household migrates every year', '')).lower()
    if migrates == 'yes':
        score += 12
        risk_factors.append('Annual Migration')
    
    # Missing children
    missing_boys = row.get('If Yes, how many boys are missing', 0)
    missing_girls = row.get('If Yes, how many girls are missing', 0)
    try:
        if pd.notna(missing_boys) and float(missing_boys) > 0:
            score += 25
            risk_factors.append(f'Missing Boys: {int(missing_boys)}')
        if pd.notna(missing_girls) and float(missing_girls) > 0:
            score += 25
            risk_factors.append(f'Missing Girls: {int(missing_girls)}')
    except:
        pass
    
    return min(score, 100), risk_factors

def get_risk_level(score):
    """Convert score to risk level."""
    if score >= 50:
        return 'High'
    elif score >= 25:
        return 'Medium'
    elif score > 0:
        return 'Low'
    return 'Minimal'

def process_data():
    """Process all data and generate vulnerability analysis."""
    # Load data
    labor_df = load_labor_data()
    hh_df = load_household_data()
    
    print("\nProcessing vulnerability scores...")
    
    # Calculate child vulnerability scores
    child_scores = []
    for idx, row in labor_df.iterrows():
        score, factors = calculate_child_vulnerability_score(row)
        child_scores.append({
            'score': score,
            'factors': factors,
            'risk_level': get_risk_level(score)
        })
    
    labor_df['VulnerabilityScore'] = [s['score'] for s in child_scores]
    labor_df['RiskFactors'] = [s['factors'] for s in child_scores]
    labor_df['RiskLevel'] = [s['risk_level'] for s in child_scores]
    
    # Calculate household vulnerability scores
    hh_scores = []
    for idx, row in hh_df.iterrows():
        score, factors = calculate_household_vulnerability(row)
        hh_scores.append({
            'score': score,
            'factors': factors,
            'risk_level': get_risk_level(score)
        })
    
    hh_df['VulnerabilityScore'] = [s['score'] for s in hh_scores]
    hh_df['RiskFactors'] = [s['factors'] for s in hh_scores]
    hh_df['RiskLevel'] = [s['risk_level'] for s in hh_scores]
    
    print("Generating summary statistics...")
    
    # Generate summary data
    result = {
        'totalChildren': len(labor_df),
        'totalHouseholds': len(hh_df),
        'lastUpdated': pd.Timestamp.now().isoformat(),
        
        # Child vulnerability summary
        'childVulnerability': {
            'byRiskLevel': labor_df['RiskLevel'].value_counts().to_dict(),
            'averageScore': float(labor_df['VulnerabilityScore'].mean()),
            'highRiskCount': int((labor_df['RiskLevel'] == 'High').sum()),
            'mediumRiskCount': int((labor_df['RiskLevel'] == 'Medium').sum()),
        },
        
        # Household vulnerability summary
        'householdVulnerability': {
            'byRiskLevel': hh_df['RiskLevel'].value_counts().to_dict(),
            'averageScore': float(hh_df['VulnerabilityScore'].mean()),
            'highRiskCount': int((hh_df['RiskLevel'] == 'High').sum()),
            'mediumRiskCount': int((hh_df['RiskLevel'] == 'Medium').sum()),
        },
        
        # By Year
        'byYear': {},
        
        # By Region
        'byRegion': {},
        
        # By State
        'byState': {},
        
        # By District
        'byDistrict': {},
        
        # By Project
        'byProject': {},
        
        # By Age Band
        'byAgeBand': {},
        
        # By Gender
        'byGender': {},
        
        # Enrollment Status breakdown
        'enrollmentStatus': labor_df['Enrollment status'].value_counts().to_dict(),
        
        # Economic Activity breakdown
        'economicActivity': labor_df['Is the child involved in any Economic activities? (with or without wage/ monetary compensation for the child)'].value_counts().to_dict(),
        
        # Migration breakdown
        'migrationStatus': labor_df['Child migrated in the last 3 months?'].value_counts().to_dict(),
        
        # Bonded Labor
        'bondedLabor': labor_df['Bonded labour involvement'].value_counts().to_dict(),
        
        # Household indicators
        'householdIndicators': {
            'singleParent': hh_df['Whether the HH is headed by a single parent'].value_counts().to_dict(),
            'grandparentHeaded': hh_df['Whether the HH is headed by grand parents'].value_counts().to_dict(),
            'childHeaded': hh_df['Whether headed by children (18 years and below)'].value_counts().to_dict(),
            'primaryEarnerIll': hh_df['Whether the primary bread-earner of the HH is terminally/seriously ill'].value_counts().to_dict(),
            'rationCard': hh_df['Type of Ration card'].value_counts().to_dict(),
        },
        
        # Risk factor frequency
        'topRiskFactors': {},
    }
    
    # By Year
    for year in labor_df['Year'].unique():
        year_data = labor_df[labor_df['Year'] == year]
        result['byYear'][str(int(year))] = {
            'count': int(len(year_data)),
            'highRisk': int((year_data['RiskLevel'] == 'High').sum()),
            'mediumRisk': int((year_data['RiskLevel'] == 'Medium').sum()),
            'lowRisk': int((year_data['RiskLevel'] == 'Low').sum()),
            'avgScore': float(year_data['VulnerabilityScore'].mean()),
        }
    
    # By Region
    for region in labor_df['Region Name'].dropna().unique():
        region_data = labor_df[labor_df['Region Name'] == region]
        if len(region_data) > 0:
            result['byRegion'][str(region)] = {
                'count': int(len(region_data)),
                'highRisk': int((region_data['RiskLevel'] == 'High').sum()),
                'mediumRisk': int((region_data['RiskLevel'] == 'Medium').sum()),
                'avgScore': float(region_data['VulnerabilityScore'].mean()),
                'boys': int((region_data['Gender'] == 'male').sum()),
                'girls': int((region_data['Gender'] == 'female').sum()),
            }
    
    # By State (top 20)
    state_counts = labor_df.groupby('State Name').agg({
        'VulnerabilityScore': ['count', 'mean'],
        'RiskLevel': lambda x: (x == 'High').sum()
    }).reset_index()
    state_counts.columns = ['State', 'Count', 'AvgScore', 'HighRisk']
    state_counts = state_counts.nlargest(20, 'Count')
    
    for _, row in state_counts.iterrows():
        state = str(row['State'])
        if state and state != 'nan':
            result['byState'][state] = {
                'count': int(row['Count']),
                'avgScore': float(row['AvgScore']),
                'highRisk': int(row['HighRisk']),
            }
    
    # By District (top 30)
    district_counts = labor_df.groupby('District Name').agg({
        'VulnerabilityScore': ['count', 'mean'],
        'RiskLevel': lambda x: (x == 'High').sum()
    }).reset_index()
    district_counts.columns = ['District', 'Count', 'AvgScore', 'HighRisk']
    district_counts = district_counts.nlargest(30, 'Count')
    
    for _, row in district_counts.iterrows():
        district = str(row['District'])
        if district and district != 'nan':
            result['byDistrict'][district] = {
                'count': int(row['Count']),
                'avgScore': float(row['AvgScore']),
                'highRisk': int(row['HighRisk']),
            }
    
    # By Project (top 20)
    project_counts = labor_df.groupby('Project Name').agg({
        'VulnerabilityScore': ['count', 'mean'],
        'RiskLevel': lambda x: (x == 'High').sum()
    }).reset_index()
    project_counts.columns = ['Project', 'Count', 'AvgScore', 'HighRisk']
    project_counts = project_counts.nlargest(20, 'Count')
    
    for _, row in project_counts.iterrows():
        project = str(row['Project'])
        if project and project != 'nan':
            result['byProject'][project] = {
                'count': int(row['Count']),
                'avgScore': float(row['AvgScore']),
                'highRisk': int(row['HighRisk']),
            }
    
    # By Age Band
    for age_band in labor_df['Age Band'].dropna().unique():
        age_data = labor_df[labor_df['Age Band'] == age_band]
        if len(age_data) > 100:  # Only include significant age bands
            result['byAgeBand'][str(age_band)] = {
                'count': int(len(age_data)),
                'highRisk': int((age_data['RiskLevel'] == 'High').sum()),
                'mediumRisk': int((age_data['RiskLevel'] == 'Medium').sum()),
                'avgScore': float(age_data['VulnerabilityScore'].mean()),
            }
    
    # By Gender
    for gender in labor_df['Gender'].dropna().unique():
        gender_data = labor_df[labor_df['Gender'] == gender]
        result['byGender'][str(gender)] = {
            'count': int(len(gender_data)),
            'highRisk': int((gender_data['RiskLevel'] == 'High').sum()),
            'mediumRisk': int((gender_data['RiskLevel'] == 'Medium').sum()),
            'avgScore': float(gender_data['VulnerabilityScore'].mean()),
        }
    
    # Top risk factors
    all_factors = []
    for factors in labor_df['RiskFactors']:
        all_factors.extend(factors)
    
    from collections import Counter
    factor_counts = Counter(all_factors)
    result['topRiskFactors'] = dict(factor_counts.most_common(15))
    
    # Sample high-risk children for detailed view (full IDs with household linking)
    high_risk = labor_df[labor_df['RiskLevel'] == 'High'].head(100)
    result['sampleHighRiskCases'] = []
    for _, row in high_risk.iterrows():
        result['sampleHighRiskCases'].append({
            'childId': str(row.get('Beneficiary Id', '')),
            'childCryAdminId': str(row.get('Beneficiary Cry Admin Id', '')),
            'householdId': str(row.get('House Hold Id', '')),
            'householdCryAdminId': str(row.get('Household CRY Admin ID', '')),
            'age': str(row.get('Age', 'Unknown')),
            'ageBand': str(row.get('Age Band', 'Unknown')),
            'gender': str(row.get('Gender', 'Unknown')),
            'region': str(row.get('Region Name', 'Unknown')),
            'state': str(row.get('State Name', 'Unknown')),
            'district': str(row.get('District Name', 'Unknown')),
            'project': str(row.get('Project Name', 'Unknown')),
            'enrollmentStatus': str(row.get('Enrollment status', 'Unknown')),
            'economicActivity': str(row.get('Is the child involved in any Economic activities? (with or without wage/ monetary compensation for the child)', 'Unknown')),
            'migrationStatus': str(row.get('Child migrated in the last 3 months?', 'Unknown')),
            'bondedLabor': str(row.get('Bonded labour involvement', 'Unknown')),
            'score': int(row['VulnerabilityScore']),
            'riskFactors': row['RiskFactors'],
            'year': int(row['Year']),
        })
    
    return result

def main():
    print("=" * 60)
    print("VULNERABILITY DATA GENERATION")
    print("=" * 60)
    
    result = process_data()
    
    # Save to JSON
    print(f"\nSaving to {OUTPUT_PATH}...")
    with open(OUTPUT_PATH, 'w', encoding='utf-8') as f:
        json.dump(result, f, indent=2, ensure_ascii=False, default=str)
    
    print("\n" + "=" * 60)
    print("SUMMARY")
    print("=" * 60)
    print(f"Total Children Analyzed: {result['totalChildren']:,}")
    print(f"Total Households Analyzed: {result['totalHouseholds']:,}")
    print(f"\nChild Vulnerability:")
    print(f"  High Risk: {result['childVulnerability']['highRiskCount']:,}")
    print(f"  Medium Risk: {result['childVulnerability']['mediumRiskCount']:,}")
    print(f"  Average Score: {result['childVulnerability']['averageScore']:.1f}")
    print(f"\nHousehold Vulnerability:")
    print(f"  High Risk: {result['householdVulnerability']['highRiskCount']:,}")
    print(f"  Medium Risk: {result['householdVulnerability']['mediumRiskCount']:,}")
    print(f"\nTop Risk Factors:")
    for factor, count in list(result['topRiskFactors'].items())[:5]:
        print(f"  {factor}: {count:,}")
    
    print("\nDone!")

if __name__ == "__main__":
    main()
