"""
Enhanced Vulnerability Score Calculator
Based on CRY Protection Vulnerability Parameters Matrix

Child Marriage Risk Factors (Max 100 points):
1. Out of school adol girl children (10-18) - 0.2 (20 points)
2. Children irregular to school - 0.05 (5 points)
3. History of child marriage (sibling married as child) - 0.15 (15 points)
4. Marriage earlier averted/stopped - 0.2 (20 points)
5. Two or more girl children in family - 0.05 (5 points)
6. Orphan/single-parent girl child - 0.15 (15 points)
7. Parents disabled/unable to work - 0.05 (5 points)
8. Risk prone areas (natural disasters, high CM rate, cultural practices) - 0.05 (5 points)
9. History of protection issues (abuse, trafficking, missing) - 0.1 (10 points)

Child Labour Risk Factors (Max 100 points):
1. Out of school children (6-18) - 0.15 (15 points)
2. Children involved in economic activities - 0.15 (15 points)
3. Rescued from CL, not mainstreamed - 0.2 (20 points)
4. Children irregular to school - 0.1 (10 points)
5. Orphan/single-parent child - 0.1 (10 points)
6. Economically weaker HH/disabled parents - 0.1 (10 points)
7. Risk prone areas (natural disasters) - 0.1 (10 points)
8. History of protection issues - 0.1 (10 points)

Child Trafficking Risk Factors (Max 100 points):
1. Out of school + economic activities - 0.25 (25 points)
2. Children in migrant families - 0.2 (20 points)
3. Orphan/single-parent child - 0.2 (20 points)
4. Economically weaker HH/disabled parents - 0.1 (10 points)
5. Trafficking hotspot locations - 0.2 (20 points)
6. Family history of trafficking/missing - 0.15 (15 points)
"""

import pandas as pd
import numpy as np
import json
from datetime import datetime
from collections import defaultdict

# High child marriage rate states (per NFHS-5 data)
HIGH_CM_STATES = {
    'Bihar', 'West Bengal', 'Jharkhand', 'Rajasthan', 'Uttar Pradesh',
    'Madhya Pradesh', 'Andhra Pradesh', 'Telangana', 'Assam', 'Tripura'
}

# Trafficking hotspot states
TRAFFICKING_HOTSPOTS = {
    'West Bengal', 'Bihar', 'Jharkhand', 'Assam', 'Odisha',
    'Uttar Pradesh', 'Madhya Pradesh', 'Rajasthan', 'Maharashtra', 'Andhra Pradesh'
}

# Child labour prone states
CHILD_LABOUR_STATES = {
    'Bihar', 'Uttar Pradesh', 'Madhya Pradesh', 'Rajasthan', 
    'Maharashtra', 'Gujarat', 'West Bengal', 'Andhra Pradesh', 'Tamil Nadu'
}


def load_excel_data():
    """Load all relevant Excel files"""
    print("Loading Excel data...")
    
    # Child Education data
    edu_2024 = pd.read_excel('excel-data/child-education_Consolidated_2024.xlsx')
    edu_2023 = pd.read_excel('excel-data/Child_education_Consolidated-2023.xlsx')
    
    # Child Annual data
    annual_2024 = pd.read_excel('excel-data/child-annual-information_Report_2024.xlsx')
    annual_2023 = pd.read_excel('excel-data/Child_Annual_2023.xlsx')
    
    # Household data
    hh_2024 = pd.read_excel('excel-data/HH-2024.xlsx')
    hh_2023 = pd.read_excel('excel-data/HH-2023.xlsx')
    
    # Labour and Migration data
    labour_2024 = pd.read_excel('excel-data/Consolidated_Labour_and_Migration_2024.xlsx')
    labour_2023 = pd.read_excel('excel-data/Consolidated-labour-and-migration2023.xlsx')
    
    print(f"Education 2024: {len(edu_2024)} rows")
    print(f"Education 2023: {len(edu_2023)} rows")
    print(f"Annual 2024: {len(annual_2024)} rows")
    print(f"Annual 2023: {len(annual_2023)} rows")
    print(f"HH 2024: {len(hh_2024)} rows")
    print(f"HH 2023: {len(hh_2023)} rows")
    print(f"Labour 2024: {len(labour_2024)} rows")
    print(f"Labour 2023: {len(labour_2023)} rows")
    
    return {
        'edu_2024': edu_2024,
        'edu_2023': edu_2023,
        'annual_2024': annual_2024,
        'annual_2023': annual_2023,
        'hh_2024': hh_2024,
        'hh_2023': hh_2023,
        'labour_2024': labour_2024,
        'labour_2023': labour_2023
    }


def count_girls_in_household(annual_df):
    """Count number of girl children per household"""
    girls_per_hh = annual_df[annual_df['Gender'].str.upper() == 'FEMALE'].groupby('House Hold Id').size()
    return girls_per_hh.to_dict()


def identify_irregular_students(edu_df):
    """Identify children with irregular school attendance"""
    # Check enrollment status for indicators of irregularity
    if 'If enrolled, enrollment status' in edu_df.columns:
        irregular = edu_df[
            edu_df['If enrolled, enrollment status'].str.lower().str.contains('irregular|drop|absent', na=False)
        ]['Beneficiary Id'].tolist()
        return set(irregular)
    return set()


def identify_out_of_school(edu_df):
    """Identify out of school children"""
    out_of_school = set()
    
    if 'Ever Enrolled' in edu_df.columns:
        never_enrolled = edu_df[edu_df['Ever Enrolled'].str.lower() == 'no']['Beneficiary Id'].tolist()
        out_of_school.update(never_enrolled)
    
    if 'If enrolled, enrollment status' in edu_df.columns:
        dropouts = edu_df[
            edu_df['If enrolled, enrollment status'].str.lower().str.contains('drop|left|discontinued', na=False)
        ]['Beneficiary Id'].tolist()
        out_of_school.update(dropouts)
    
    return out_of_school


def identify_economic_activity(labour_df):
    """Identify children involved in economic activities"""
    economic_children = set()
    
    for col in labour_df.columns:
        if 'economic' in col.lower() or 'work' in col.lower() or 'labour' in col.lower():
            active = labour_df[
                labour_df[col].notna() & 
                (labour_df[col].astype(str).str.lower() != 'no') &
                (labour_df[col].astype(str).str.lower() != 'none') &
                (labour_df[col].astype(str).str.lower() != 'not applicable')
            ]
            if 'Beneficiary Id' in active.columns:
                economic_children.update(active['Beneficiary Id'].tolist())
    
    return economic_children


def identify_migrants(labour_df):
    """Identify children from migrant families"""
    migrants = set()
    
    for col in labour_df.columns:
        if 'migra' in col.lower():
            migrant_df = labour_df[
                labour_df[col].notna() & 
                (labour_df[col].astype(str).str.lower() != 'no') &
                (labour_df[col].astype(str).str.lower() != 'non-migrant') &
                (labour_df[col].astype(str).str.lower() != 'not applicable')
            ]
            if 'Beneficiary Id' in migrant_df.columns:
                migrants.update(migrant_df['Beneficiary Id'].tolist())
    
    return migrants


def identify_orphans_single_parent(annual_df):
    """Identify orphans and single parent children"""
    orphans = set()
    
    if 'Orphaned /Single parent' in annual_df.columns:
        orphan_df = annual_df[
            annual_df['Orphaned /Single parent'].notna() &
            (annual_df['Orphaned /Single parent'].astype(str).str.lower() != 'no') &
            (annual_df['Orphaned /Single parent'].astype(str).str.lower() != 'both parents alive')
        ]
        orphans.update(orphan_df['Beneficiary Id'].tolist())
    
    return orphans


def calculate_child_marriage_score(child, data_context):
    """
    Calculate child marriage vulnerability score based on the matrix
    Only applicable to adolescent girls (10-18 years)
    """
    score = 0
    risk_factors = []
    
    gender = child.get('gender', '').upper()
    age_band = child.get('age_band', '')
    beneficiary_id = child.get('beneficiary_id')
    household_id = child.get('household_id')
    state = child.get('state', '')
    
    # Only calculate for girls in age groups 11-14Y or 15-18Y (or 10-18 range)
    if gender != 'FEMALE':
        return 0, []
    
    adolescent_bands = ['11-14Y', '15-18Y', '6-10Y']  # Include older children in 6-10Y who might be 10
    if age_band not in adolescent_bands:
        return 0, []
    
    # 1. Out of school (20 points)
    if beneficiary_id in data_context['out_of_school']:
        score += 20
        risk_factors.append('Out of school')
    
    # 2. Irregular school attendance (5 points)
    if beneficiary_id in data_context['irregular_students']:
        score += 5
        risk_factors.append('Irregular attendance')
    
    # 3. History of child marriage in family - two or more girl children (proxy) (15 points)
    girls_count = data_context['girls_per_household'].get(household_id, 0)
    if girls_count >= 2:
        score += 15
        risk_factors.append('History of CM in family (multiple girls)')
    
    # 4. Two or more girl children in family (5 points) - additional to above
    if girls_count >= 2:
        score += 5
        risk_factors.append('2+ girl children in household')
    
    # 5. Orphan/single-parent (15 points)
    if beneficiary_id in data_context['orphans']:
        score += 15
        risk_factors.append('Orphan/single parent')
    
    # 6. Parents disabled/unable to work (5 points) - check from household data
    if beneficiary_id in data_context.get('disabled_parents', set()):
        score += 5
        risk_factors.append('Parent disability')
    
    # 7. Risk prone area - high child marriage state (5 points)
    if state in HIGH_CM_STATES:
        score += 5
        risk_factors.append(f'High CM rate area ({state})')
    
    # 8. Economic activity involvement (proxy for protection issues) (10 points)
    if beneficiary_id in data_context['economic_activity']:
        score += 10
        risk_factors.append('Economic activity involvement')
    
    return score, risk_factors


def calculate_child_labour_score(child, data_context):
    """
    Calculate child labour vulnerability score based on the matrix
    Applicable to children 6-18 years
    """
    score = 0
    risk_factors = []
    
    age_band = child.get('age_band', '')
    beneficiary_id = child.get('beneficiary_id')
    state = child.get('state', '')
    
    # Only applicable for 6-18 years
    labour_age_bands = ['6-10Y', '11-14Y', '15-18Y']
    if age_band not in labour_age_bands:
        return 0, []
    
    # 1. Out of school (15 points)
    if beneficiary_id in data_context['out_of_school']:
        score += 15
        risk_factors.append('Out of school')
    
    # 2. Economic activity involvement (15 points)
    if beneficiary_id in data_context['economic_activity']:
        score += 15
        risk_factors.append('Economic activity')
    
    # 3. Irregular attendance (10 points)
    if beneficiary_id in data_context['irregular_students']:
        score += 10
        risk_factors.append('Irregular attendance')
    
    # 4. Orphan/single parent (10 points)
    if beneficiary_id in data_context['orphans']:
        score += 10
        risk_factors.append('Orphan/single parent')
    
    # 5. Migrant family (10 points as proxy for economically weaker)
    if beneficiary_id in data_context['migrants']:
        score += 10
        risk_factors.append('Migrant family')
    
    # 6. Risk prone area - child labour state (10 points)
    if state in CHILD_LABOUR_STATES:
        score += 10
        risk_factors.append(f'Child labour prone area ({state})')
    
    # 7. Combined: out of school + economic activity (additional 10 points for high risk combination)
    if beneficiary_id in data_context['out_of_school'] and beneficiary_id in data_context['economic_activity']:
        score += 10
        risk_factors.append('Out of school + Economic activity (combined)')
    
    return score, risk_factors


def calculate_child_trafficking_score(child, data_context):
    """
    Calculate child trafficking vulnerability score based on the matrix
    Applicable to children 6-18 years
    """
    score = 0
    risk_factors = []
    
    age_band = child.get('age_band', '')
    beneficiary_id = child.get('beneficiary_id')
    state = child.get('state', '')
    
    # Only applicable for 6-18 years
    trafficking_age_bands = ['6-10Y', '11-14Y', '15-18Y']
    if age_band not in trafficking_age_bands:
        return 0, []
    
    # 1. Out of school + economic activities (25 points)
    if beneficiary_id in data_context['out_of_school'] and beneficiary_id in data_context['economic_activity']:
        score += 25
        risk_factors.append('Out of school + Economic activity')
    elif beneficiary_id in data_context['out_of_school']:
        score += 12  # Partial score for just out of school
        risk_factors.append('Out of school')
    elif beneficiary_id in data_context['economic_activity']:
        score += 12  # Partial score for just economic activity
        risk_factors.append('Economic activity')
    
    # 2. Migrant family (20 points)
    if beneficiary_id in data_context['migrants']:
        score += 20
        risk_factors.append('Migrant family')
    
    # 3. Orphan/single parent (20 points)
    if beneficiary_id in data_context['orphans']:
        score += 20
        risk_factors.append('Orphan/single parent')
    
    # 4. Trafficking hotspot location (20 points)
    if state in TRAFFICKING_HOTSPOTS:
        score += 20
        risk_factors.append(f'Trafficking hotspot ({state})')
    
    return score, risk_factors


def process_vulnerability_data(data):
    """Process all data and calculate vulnerability scores"""
    print("\nPreparing data context...")
    
    # Combine education data
    edu_combined = pd.concat([data['edu_2024'], data['edu_2023']], ignore_index=True)
    
    # Combine annual data
    annual_combined = pd.concat([data['annual_2024'], data['annual_2023']], ignore_index=True)
    
    # Combine labour data
    labour_combined = pd.concat([data['labour_2024'], data['labour_2023']], ignore_index=True)
    
    # Build data context for lookups
    data_context = {
        'out_of_school': identify_out_of_school(edu_combined),
        'irregular_students': identify_irregular_students(edu_combined),
        'economic_activity': identify_economic_activity(labour_combined),
        'migrants': identify_migrants(labour_combined),
        'orphans': identify_orphans_single_parent(annual_combined),
        'girls_per_household': count_girls_in_household(annual_combined),
        'disabled_parents': set()  # Would need HH data analysis
    }
    
    print(f"Out of school children: {len(data_context['out_of_school'])}")
    print(f"Irregular students: {len(data_context['irregular_students'])}")
    print(f"Economic activity involvement: {len(data_context['economic_activity'])}")
    print(f"Migrants: {len(data_context['migrants'])}")
    print(f"Orphans/single parent: {len(data_context['orphans'])}")
    print(f"Households with 2+ girls: {sum(1 for v in data_context['girls_per_household'].values() if v >= 2)}")
    
    # Process each child
    print("\nCalculating vulnerability scores...")
    
    child_marriage_results = {'high': [], 'medium': [], 'low': [], 'minimal': [], 'scores': []}
    child_labour_results = {'high': [], 'medium': [], 'low': [], 'minimal': [], 'scores': []}
    child_trafficking_results = {'high': [], 'medium': [], 'low': [], 'minimal': [], 'scores': []}
    
    # Region, state, age band aggregations
    cm_by_region = defaultdict(lambda: {'atRisk': 0, 'highRisk': 0, 'mediumRisk': 0})
    cl_by_region = defaultdict(lambda: {'atRisk': 0, 'highRisk': 0, 'mediumRisk': 0})
    ct_by_region = defaultdict(lambda: {'atRisk': 0, 'highRisk': 0, 'mediumRisk': 0})
    
    cm_by_age = defaultdict(lambda: {'atRisk': 0, 'highRisk': 0, 'mediumRisk': 0})
    cl_by_age = defaultdict(lambda: {'atRisk': 0, 'highRisk': 0, 'mediumRisk': 0})
    ct_by_age = defaultdict(lambda: {'atRisk': 0, 'highRisk': 0, 'mediumRisk': 0})
    
    sample_cases = {
        'childMarriage': [],
        'childLabour': [],
        'childTrafficking': []
    }
    
    # Process annual data (has most comprehensive child info)
    for _, row in annual_combined.iterrows():
        child = {
            'beneficiary_id': row.get('Beneficiary Id'),
            'household_id': row.get('House Hold Id'),
            'gender': str(row.get('Gender', '')),
            'age_band': str(row.get('Age Band', '')),
            'age': row.get('Age'),
            'region': str(row.get('Region Name', '')),
            'state': str(row.get('State Name', '')),
            'district': str(row.get('District Name', '')),
        }
        
        # Child Marriage Score
        cm_score, cm_factors = calculate_child_marriage_score(child, data_context)
        if cm_score > 0:
            child_marriage_results['scores'].append(cm_score)
            region = child['region']
            age_band = child['age_band']
            
            if cm_score >= 50:
                child_marriage_results['high'].append(child)
                cm_by_region[region]['highRisk'] += 1
                cm_by_age[age_band]['highRisk'] += 1
                if len(sample_cases['childMarriage']) < 10:
                    sample_cases['childMarriage'].append({
                        'childId': str(child['beneficiary_id']),
                        'age': str(child['age']),
                        'ageBand': child['age_band'],
                        'gender': child['gender'],
                        'region': child['region'],
                        'state': child['state'],
                        'district': child['district'],
                        'score': cm_score,
                        'riskLevel': 'High',
                        'riskFactors': cm_factors
                    })
            elif cm_score >= 25:
                child_marriage_results['medium'].append(child)
                cm_by_region[region]['mediumRisk'] += 1
                cm_by_age[age_band]['mediumRisk'] += 1
            elif cm_score >= 10:
                child_marriage_results['low'].append(child)
            else:
                child_marriage_results['minimal'].append(child)
            
            cm_by_region[region]['atRisk'] += 1
            cm_by_age[age_band]['atRisk'] += 1
        
        # Child Labour Score
        cl_score, cl_factors = calculate_child_labour_score(child, data_context)
        if cl_score > 0:
            child_labour_results['scores'].append(cl_score)
            region = child['region']
            age_band = child['age_band']
            
            if cl_score >= 50:
                child_labour_results['high'].append(child)
                cl_by_region[region]['highRisk'] += 1
                cl_by_age[age_band]['highRisk'] += 1
                if len(sample_cases['childLabour']) < 10:
                    sample_cases['childLabour'].append({
                        'childId': str(child['beneficiary_id']),
                        'age': str(child['age']),
                        'ageBand': child['age_band'],
                        'gender': child['gender'],
                        'region': child['region'],
                        'state': child['state'],
                        'district': child['district'],
                        'score': cl_score,
                        'riskLevel': 'High',
                        'riskFactors': cl_factors
                    })
            elif cl_score >= 25:
                child_labour_results['medium'].append(child)
                cl_by_region[region]['mediumRisk'] += 1
                cl_by_age[age_band]['mediumRisk'] += 1
            elif cl_score >= 10:
                child_labour_results['low'].append(child)
            else:
                child_labour_results['minimal'].append(child)
            
            cl_by_region[region]['atRisk'] += 1
            cl_by_age[age_band]['atRisk'] += 1
        
        # Child Trafficking Score
        ct_score, ct_factors = calculate_child_trafficking_score(child, data_context)
        if ct_score > 0:
            child_trafficking_results['scores'].append(ct_score)
            region = child['region']
            age_band = child['age_band']
            
            if ct_score >= 50:
                child_trafficking_results['high'].append(child)
                ct_by_region[region]['highRisk'] += 1
                ct_by_age[age_band]['highRisk'] += 1
                if len(sample_cases['childTrafficking']) < 10:
                    sample_cases['childTrafficking'].append({
                        'childId': str(child['beneficiary_id']),
                        'age': str(child['age']),
                        'ageBand': child['age_band'],
                        'gender': child['gender'],
                        'region': child['region'],
                        'state': child['state'],
                        'district': child['district'],
                        'score': ct_score,
                        'riskLevel': 'High',
                        'riskFactors': ct_factors
                    })
            elif ct_score >= 25:
                child_trafficking_results['medium'].append(child)
                ct_by_region[region]['mediumRisk'] += 1
                ct_by_age[age_band]['mediumRisk'] += 1
            elif ct_score >= 10:
                child_trafficking_results['low'].append(child)
            else:
                child_trafficking_results['minimal'].append(child)
            
            ct_by_region[region]['atRisk'] += 1
            ct_by_age[age_band]['atRisk'] += 1
    
    # Calculate statistics
    def calc_stats(results):
        scores = results['scores']
        return {
            'totalAtRisk': len(results['high']) + len(results['medium']) + len(results['low']),
            'highRisk': len(results['high']),
            'mediumRisk': len(results['medium']),
            'lowRisk': len(results['low']),
            'avgScore': np.mean(scores) if scores else 0,
            'maxScore': max(scores) if scores else 0,
            'byRiskLevel': {
                'Minimal': len(results['minimal']),
                'Low': len(results['low']),
                'Medium': len(results['medium']),
                'High': len(results['high'])
            },
            'byScoreBand': {
                '0': len(results['minimal']),
                '1-24': len(results['low']),
                '25-49': len(results['medium']),
                '50+': len(results['high'])
            }
        }
    
    protection_vulnerability = {
        'childMarriage': calc_stats(child_marriage_results),
        'childLabour': calc_stats(child_labour_results),
        'childTrafficking': calc_stats(child_trafficking_results)
    }
    
    # Format region data
    protection_by_region = {}
    all_regions = set(cm_by_region.keys()) | set(cl_by_region.keys()) | set(ct_by_region.keys())
    for region in all_regions:
        if region:  # Skip empty regions
            protection_by_region[region] = {
                'childMarriage': dict(cm_by_region.get(region, {'atRisk': 0, 'highRisk': 0, 'mediumRisk': 0})),
                'childLabour': dict(cl_by_region.get(region, {'atRisk': 0, 'highRisk': 0, 'mediumRisk': 0})),
                'childTrafficking': dict(ct_by_region.get(region, {'atRisk': 0, 'highRisk': 0, 'mediumRisk': 0}))
            }
    
    # Format age band data
    protection_by_age_band = {}
    all_age_bands = set(cm_by_age.keys()) | set(cl_by_age.keys()) | set(ct_by_age.keys())
    for age_band in all_age_bands:
        if age_band:
            protection_by_age_band[age_band] = {
                'childMarriage': dict(cm_by_age.get(age_band, {'atRisk': 0, 'highRisk': 0, 'mediumRisk': 0})),
                'childLabour': dict(cl_by_age.get(age_band, {'atRisk': 0, 'highRisk': 0, 'mediumRisk': 0})),
                'childTrafficking': dict(ct_by_age.get(age_band, {'atRisk': 0, 'highRisk': 0, 'mediumRisk': 0}))
            }
    
    return {
        'protectionVulnerability': protection_vulnerability,
        'protectionByRegion': protection_by_region,
        'protectionByAgeBand': protection_by_age_band,
        'sampleProtectionCases': sample_cases
    }


def update_vulnerability_json(new_data):
    """Update the vulnerability JSON file with new protection data"""
    print("\nUpdating vulnerability_data.json...")
    
    # Load existing data
    with open('public/data/vulnerability_data.json', 'r') as f:
        existing_data = json.load(f)
    
    # Update with new protection vulnerability data
    existing_data['protectionVulnerability'] = new_data['protectionVulnerability']
    existing_data['protectionByRegion'] = new_data['protectionByRegion']
    existing_data['protectionByAgeBand'] = new_data['protectionByAgeBand']
    existing_data['sampleProtectionCases'] = new_data['sampleProtectionCases']
    existing_data['lastUpdated'] = datetime.now().isoformat()
    
    # Save updated data
    with open('public/data/vulnerability_data.json', 'w') as f:
        json.dump(existing_data, f, indent=2)
    
    print("Vulnerability data updated successfully!")
    
    # Print summary
    pv = new_data['protectionVulnerability']
    print("\n=== PROTECTION VULNERABILITY SUMMARY ===")
    print(f"\nChild Marriage:")
    print(f"  Total at Risk: {pv['childMarriage']['totalAtRisk']}")
    print(f"  High Risk (50+): {pv['childMarriage']['highRisk']}")
    print(f"  Medium Risk (25-49): {pv['childMarriage']['mediumRisk']}")
    print(f"  Low Risk (10-24): {pv['childMarriage']['lowRisk']}")
    print(f"  Max Score: {pv['childMarriage']['maxScore']}")
    
    print(f"\nChild Labour:")
    print(f"  Total at Risk: {pv['childLabour']['totalAtRisk']}")
    print(f"  High Risk (50+): {pv['childLabour']['highRisk']}")
    print(f"  Medium Risk (25-49): {pv['childLabour']['mediumRisk']}")
    print(f"  Low Risk (10-24): {pv['childLabour']['lowRisk']}")
    print(f"  Max Score: {pv['childLabour']['maxScore']}")
    
    print(f"\nChild Trafficking:")
    print(f"  Total at Risk: {pv['childTrafficking']['totalAtRisk']}")
    print(f"  High Risk (50+): {pv['childTrafficking']['highRisk']}")
    print(f"  Medium Risk (25-49): {pv['childTrafficking']['mediumRisk']}")
    print(f"  Low Risk (10-24): {pv['childTrafficking']['lowRisk']}")
    print(f"  Max Score: {pv['childTrafficking']['maxScore']}")


def main():
    print("=" * 60)
    print("ENHANCED VULNERABILITY SCORE CALCULATOR")
    print("Based on CRY Protection Vulnerability Parameters Matrix")
    print("=" * 60)
    
    # Load data
    data = load_excel_data()
    
    # Process vulnerability scores
    new_vulnerability_data = process_vulnerability_data(data)
    
    # Update JSON
    update_vulnerability_json(new_vulnerability_data)
    
    print("\n" + "=" * 60)
    print("COMPLETED!")
    print("=" * 60)


if __name__ == '__main__':
    main()
